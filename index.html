<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Pizza Factory — Clean Levels (No Shadows)</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root{--bg:#eaf2ff;--card:#fff;--ink:#0f172a;--muted:#6b7280;--accent:#22c55e;--accent2:#3b82f6;--shadow:0 10px 28px rgba(0,0,0,.08)}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Cairo",sans-serif;background:radial-gradient(1000px 540px at 50% -10%,#fff,var(--bg));color:var(--ink);display:flex;justify-content:center}
.app{width:min(1040px,100%);padding:12px}
.frame{background:var(--card);border-radius:24px;box-shadow:var(--shadow);overflow:hidden;border:1px solid #e8eef5}
.top{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:10px 14px;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff}
.stats{display:flex;gap:10px;flex-wrap:wrap}
.pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:rgba(255,255,255,.16);font-weight:700}
.grid{display:grid;grid-template-columns:1.2fr .8fr;gap:10px;padding:10px}
.panel{background:#f8fafc;border:1px solid #eef2f7;border-radius:18px;padding:10px}
.panel canvas{display:block;margin-inline:auto;width:100%;max-width:1000px;aspect-ratio:16/9;height:auto;background:#ffffff;border-radius:12px}
.row{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px 0}
.btn{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:10px 12px;cursor:pointer;font-weight:700}
.btn:active{transform:translateY(1px)}
.meter{height:10px;border-radius:999px;background:#eef2f7;overflow:hidden}
.meter>span{display:block;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2))}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;padding:8px}
.iconbtn{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;background:#fff;border:1px solid #e5e7eb;border-radius:12px;font-weight:700}
.hud{display:flex;justify-content:space-between;align-items:center;color:var(--muted);padding:6px 10px}
.overlay{position:fixed;inset:0;background:rgba(15,23,42,.66);display:none;place-items:center;z-index:50}
.card{background:#fff;border-radius:18px;padding:16px;width:min(520px,90%);text-align:center}
.card h2{margin:8px 0}
@media (max-width:780px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="app">
  <div class="frame">
    <div class="top">
      <b>Pizza Factory — مراحل نظيفة</b>
      <div class="stats">
        <div class="pill">💰 <b id="cash">0</b></div>
        <div class="pill">⭐ المستوى <b id="level">1</b></div>
        <div class="pill">🎯 المتبقي <b id="goalLeft">0</b></div>
        <div class="pill">⏳ الوقت <b id="time">00:00</b></div>
      </div>
    </div>

    <div class="grid">
      <div class="panel">
        <h3>الملعب (Isometric + Sprites — بدون Shadow/شبكة)</h3>
        <canvas id="cv"></canvas>
        <div class="toolbar">
          <button class="iconbtn" id="btnTut">📘 شرح سريع</button>
          <button class="iconbtn" id="btnMute">🔊 صوت</button>
          <button class="iconbtn" id="btnRestart">🔁 إعادة</button>
        </div>
      </div>
      <div class="panel">
        <h3>ترقيات</h3>
        <div class="row"><div>⏱️ سرعة الفرن</div><div><div class="meter" style="width:160px"><span id="ovenBar" style="width:20%"></span></div> <button class="btn" id="upOven">+ (120💰)</button></div></div>
        <div class="row"><div>🏃‍♂️ سرعة العامل</div><div><div class="meter" style="width:160px"><span id="speedBar" style="width:20%"></span></div> <button class="btn" id="upSpeed">+ (100💰)</button></div></div>
        <div class="row"><div>🧺 سعة الحمل</div><div><div class="meter" style="width:160px"><span id="capBar" style="width:20%"></span></div> <button class="btn" id="upCap">+ (150💰)</button></div></div>
        <div class="row"><div>📣 تسويق</div><div><div class="meter" style="width:160px"><span id="mkBar" style="width:0%"></span></div> <button class="btn" id="upMk">+ (130💰)</button></div></div>
        <div class="row"><div>حفظ</div><div><button class="btn" id="save">حفظ</button> <button class="btn" id="reset">بداية جديدة</button></div></div>
      </div>
    </div>

    <div class="hud">
      <div>👷 العامل يحمل من المخزن ويسلّم على الكاونتر. التقدّم = الإيراد فقط.</div>
      <div>🎵 أصوات خفيفة عند الإنتاج والتسليم</div>
    </div>
  </div>
</div>

<div class="overlay" id="overlay">
  <div class="card">
    <h2 id="ovTitle">شرح سريع</h2>
    <p id="ovBody">حقّق الهدف قبل نهاية الوقت. عدّاد المتبقي يقلّ بحسب الإيراد المُجمّع فقط.</p>
    <button class="btn" id="ovBtn">حسناً</button>
  </div>
</div>

<script>
// Telegram
const tg = window.Telegram?.WebApp; if(tg){try{tg.ready();tg.expand();}catch(e){}}

// Canvas
const cv = document.getElementById('cv');
const ctx = cv.getContext('2d');
function scaleCanvas(){
  const dpr = Math.max(1, window.devicePixelRatio||1);
  const rect = cv.getBoundingClientRect();
  const cssW = Math.max(640, Math.floor(rect.width||960));
  const cssH = Math.max(360, Math.floor(rect.height||cssW*9/16));
  cv.width=Math.floor(cssW*dpr); cv.height=Math.floor(cssH*dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
new ResizeObserver(scaleCanvas).observe(cv); scaleCanvas();
const W = ()=> (cv.getBoundingClientRect().width || 960);
const H = ()=> (cv.getBoundingClientRect().height|| 540);

// ===== Sprites (SVG) — بدون ظلال =====
const SPRITES = {
  worker:`<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><circle cx='32' cy='22' r='12' fill='#f97316'/><rect x='18' y='28' width='28' height='24' rx='6' fill='#3b82f6'/><rect x='16' y='16' width='18' height='6' rx='3' fill='#1d4ed8'/><rect x='34' y='18' width='10' height='4' fill='#1d4ed8'/></svg>`,
  customer:`<svg xmlns='http://www.w3.org/2000/svg' width='56' height='56'><circle cx='28' cy='18' r='10' fill='#94a3b8'/><rect x='16' y='24' width='24' height='20' rx='6' fill='#1f2937'/></svg>`,
  oven:`<svg xmlns='http://www.w3.org/2000/svg' width='96' height='64'><rect x='2' y='8' width='92' height='48' rx='10' fill='#60a5fa'/><rect x='12' y='22' width='72' height='20' rx='6' fill='#1d4ed8'/></svg>`,
  pizza:`<svg xmlns='http://www.w3.org/2000/svg' width='40' height='40'><ellipse cx='20' cy='24' rx='16' ry='6' fill='#f59e0b' stroke='#b45309' stroke-width='2'/><text x='12' y='28' font-size='16'>🍕</text></svg>`
};
let spritesReady=false, GFX={};
async function svgBmp(svg){try{const b=new Blob([svg],{type:'image/svg+xml'});const u=URL.createObjectURL(b);const i=new Image();i.decoding='async';i.src=u;await i.decode();const bmp=await createImageBitmap(i);URL.revokeObjectURL(u);return bmp;}catch{return null;}}
(async()=>{for(const k in SPRITES){GFX[k]=await svgBmp(SPRITES[k]);} spritesReady=true;})();

// ===== صوت بسيط =====
let audioCtx=null, muted=false;
function beep(freq=880,dur=0.06,type='triangle',gain=0.03){
  if(muted) return; if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  const o=audioCtx.createOscillator(), g=audioCtx.createGain();
  o.type=type; o.frequency.value=freq; g.gain.value=gain; o.connect(g).connect(audioCtx.destination);
  o.start(); o.stop(audioCtx.currentTime+dur);
}

// ===== مستويات =====
const LEVELS=[
  {goal:200,time:60, spawn:0.55, order:[1,2], oven:2, speed:1, cap:3, mk:0},
  {goal:350,time:70, spawn:0.70, order:[1,3], oven:3, speed:1, cap:3, mk:1},
  {goal:500,time:80, spawn:0.85, order:[2,3], oven:3, speed:2, cap:4, mk:1},
  {goal:700,time:90, spawn:1.00, order:[2,3], oven:4, speed:2, cap:5, mk:2},
];

// ===== حالة اللعبة =====
const S = JSON.parse(localStorage.getItem('pf_iso_levels')||'null') || {level:1, cash:200, ovenLvl:2, workerSpeed:1, carryCap:3, marketing:0};
let timeLeft=LEVELS[S.level-1].time, goal=LEVELS[S.level-1].goal;

// المؤشر الصحيح للتقدّم = الإيراد فقط
let revenueEarned = 0;

// إيزومتريك: نقطة مرجعية ثابتة
function isoOrigin(){ return {ox: W()*0.50, oy: H()*0.60}; }
const iso=(x,y)=>{const {ox,oy}=isoOrigin(); return {X:x-y+ox, Y:(x+y)*0.5+oy};};

// كيانات + مواضع
const oven={timer:0, stock:0, limit:99};
const counter={stock:0, limit:40};
const worker={x:iso(0,0).X, y:iso(0,0).Y, carrying:0, state:'toStack'};
const customers=[];
const POS={ oven:{x:-120,y:-20}, stack:{x:-60,y:-20}, counter:{x:140,y:-20}, queueX:230 };

// معدلات
function ovenInterval(){ return Math.max(0.6, 2.2 - S.ovenLvl*0.18); }
function spawnRate(){ return LEVELS[S.level-1].spawn + S.marketing*0.05; }
function patienceMax(){ return 6.5 + S.marketing*0.2; }
let spawnT=1/spawnRate();

// HUD
const $=id=>document.getElementById(id);
function goalLeft(){ return Math.max(0, goal - revenueEarned); } // ينقص فقط
function renderHUD(){
  $('cash').textContent=S.cash.toFixed(0);
  $('level').textContent=S.level;
  $('goalLeft').textContent=goalLeft().toFixed(0);
  const m=Math.floor(timeLeft/60), s=(timeLeft%60|0).toString().padStart(2,'0');
  $('time').textContent=`${m}:${s}`;
  $('ovenBar').style.width=(S.ovenLvl*10)+'%';
  $('speedBar').style.width=(S.workerSpeed*10)+'%';
  $('capBar').style.width=(S.carryCap*10)+'%';
  $('mkBar').style.width=(S.marketing*10)+'%';
}
function save(){ localStorage.setItem('pf_iso_levels', JSON.stringify(S)); }

// UI
const overlay=$('overlay'), ovTitle=$('ovTitle'), ovBody=$('ovBody'), ovBtn=$('ovBtn');
$('btnTut').onclick=()=>{ overlay.style.display='grid'; ovTitle.textContent='شرح سريع'; ovBody.textContent='عدّاد المتبقي يقلّ بالإيراد فقط. المشتريات لا تؤثر على التقدّم.'; };
$('btnMute').onclick=()=>{ muted=!muted; $('btnMute').textContent=muted?'🔇 صامت':'🔊 صوت'; };
$('btnRestart').onclick=()=>{ startLevel(S.level,true); };
$('upOven').onclick=()=>{ if(S.cash>=120){ S.cash-=120; S.ovenLvl++; beep(900); renderHUD(); save(); } };
$('upSpeed').onclick=()=>{ if(S.cash>=100){ S.cash-=100; S.workerSpeed++; beep(760); renderHUD(); save(); } };
$('upCap').onclick=()=>{ if(S.cash>=150){ S.cash-=150; S.carryCap++; beep(640); renderHUD(); save(); } };
$('upMk').onclick=()=>{ if(S.cash>=130){ S.cash-=130; S.marketing++; beep(520); renderHUD(); save(); } };
$('save').onclick=save; $('reset').onclick=()=>{ localStorage.removeItem('pf_iso_levels'); location.reload(); };

// بدء مستوى
function startLevel(n, reset=true){
  const L=LEVELS[n-1];
  timeLeft=L.time; goal=L.goal;
  S.ovenLvl=L.oven; S.workerSpeed=L.speed; S.carryCap=L.cap; S.marketing=L.mk;
  if(reset) revenueEarned = 0;                   // إعادة ضبط الإيراد للمستوى
  oven.stock=0; counter.stock=0; customers.length=0; spawnT=1/spawnRate();
  for(let i=0;i<3;i++) spawnCustomer();
  renderHUD();
  overlay.style.display='grid'; ovTitle.textContent=`المستوى ${n}`; ovBody.textContent=`المتبقي ${goalLeft()} خلال ${L.time} ثانية`; ovBtn.textContent='ابدأ';
}
startLevel(S.level,true);
ovBtn.onclick=()=>{ overlay.style.display='none'; last=performance.now(); };

// زبائن + تسليم
function spawnCustomer(){
  const r=LEVELS[S.level-1].order;
  const n=r[0]+Math.floor(Math.random()*(r[1]-r[0]+1));
  const baseY=-20+Math.random()*60; const p=iso(POS.queueX, baseY);
  customers.push({isoX:POS.queueX, isoY:baseY, scrX:p.X, scrY:p.Y, order:n, pat:patienceMax(), served:false, leaving:false});
}
function serveFromCounter(){
  const c=customers.find(z=>!z.served && !z.leaving); if(!c) return;
  const give=Math.min(counter.stock, c.order);
  if(give>0){
    c.order-=give; counter.stock-=give;
    const pay=give*10;
    S.cash+=pay; revenueEarned=Math.min(goal, revenueEarned+pay); // يزيد للإيراد فقط
    if(c.order===0){ c.served=true; beep(880,0.07,'sine',0.04); }
    renderHUD(); save();
  }
}

// العامل
const P_STACK=iso(POS.stack.x,POS.stack.y), P_COUNTER=iso(POS.counter.x,POS.counter.y);
function vPx(){ return (90+S.workerSpeed*26); }
function moveTo(o,tx,ty,dt){ const dx=tx-o.x, dy=ty-o.y, d=Math.hypot(dx,dy); if(d>1){ o.x+=

<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lemonade Tycoon — Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#f2f7ff; --card:#fff; --text:#1f2937; --muted:#6b7280;
      --brand:#22c55e; --brand2:#3b82f6; --shadow:0 12px 30px rgba(0,0,0,.08);
      --r:20px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Cairo", sans-serif; background:radial-gradient(1000px 500px at 50% -10%, #ffffff, var(--bg)); color:var(--text); -webkit-tap-highlight-color:transparent; display:flex; justify-content:center}
    .app{width:min(920px,100%); padding:16px}
    .frame{background:var(--card); border-radius:28px; box-shadow:var(--shadow); overflow:hidden}

    .header{display:flex; justify-content:space-between; align-items:center; padding:16px 18px; background:linear-gradient(90deg, var(--brand), var(--brand2)); color:#fff}
    .header b{font-size:18px}
    .stat{display:flex; gap:10px; align-items:center; background:rgba(255,255,255,.15); padding:8px 12px; border-radius:999px}

    .hero{display:grid; grid-template-columns:1.1fr .9fr; gap:16px; padding:16px}
    .shop{background:#f8fafc; border:1px solid #eef2f7; border-radius:22px; padding:14px}
    .shop h3{margin:6px 0 10px; font-size:18px}
    .row{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px 0}
    .row + .row{border-top:1px dashed #e5e7eb}
    .btn{display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:14px; border:1px solid #e5e7eb; background:#fff; box-shadow:var(--shadow); cursor:pointer; font-weight:700}
    .btn:active{transform:translateY(1px)}

    .meter{height:10px; border-radius:999px; background:#eef2f7; overflow:hidden}
    .meter > span{display:block; height:100%; background:linear-gradient(90deg, var(--brand), var(--brand2))}

    .cards{display:grid; grid-template-columns:repeat(3, 1fr); gap:12px}
    .card{background:#fff; border:1px solid #eef2f7; border-radius:18px; padding:12px; box-shadow:var(--shadow)}
    .card h4{margin:6px 0 8px}

    .footer{display:flex; justify-content:space-between; align-items:center; padding:12px 16px; color:var(--muted); border-top:1px solid #eef2f7}

    @media (max-width:720px){ .hero{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="app">
    <div class="frame">
      <div class="header">
        <b>عصير ليمون – تايكون</b>
        <div class="stat"><span>💰</span><b id="money">0</b></div>
      </div>
      <div class="hero">
        <div class="shop">
          <h3>الكشك</h3>
          <div class="row"><div>السعر/كوب</div><div><b id="price">5</b>💲 <button class="btn" id="incPrice">+1</button> <button class="btn" id="decPrice">-1</button></div></div>
          <div class="row"><div>الجودة (يرفع رضا الزبائن)</div><div><div class="meter" style="width:180px"><span id="qualityBar" style="width:20%"></span></div> <button class="btn" id="upgradeQuality">ترقية (20💰)</button></div></div>
          <div class="row"><div>الإعلانات (يزيد الزوار/الدقيقة)</div><div><div class="meter" style="width:180px"><span id="adsBar" style="width:0%"></span></div> <button class="btn" id="upgradeAds">ترقية (30💰)</button></div></div>
          <div class="row"><div>العمال (يزيد سرعة التقديم)</div><div><b id="staff">1</b> 👤 <button class="btn" id="hire">تعيين (50💰)</button></div></div>
          <div class="row"><div>المخزون (ليمونات/سكر/ماء)</div><div><b id="stock">30</b> كوب <button class="btn" id="buyStock">شراء 20 (20💰)</button></div></div>
          <div class="row"><div>الزوار/دقيقة</div><div><b id="visitors">10</b></div></div>
          <div class="row"><div>الرضا</div><div><b id="satisfaction">0%</b></div></div>
          <div class="row"><button class="btn" id="openShop">ابدأ البيع الآن</button><div id="status">جاهز</div></div>
        </div>
        <div class="cards">
          <div class="card"><h4>الإيراد اليومي</h4><div class="meter"><span id="dayBar" style="width:0%"></span></div><div style="margin-top:6px">اليوم: <b id="dayRevenue">0</b>💰</div></div>
          <div class="card"><h4>معدل الخدمة</h4><div>الطلب/ثانية: <b id="serveRate">1.0</b></div><div>الكوب/سعر: <b id="price2">5</b></div></div>
          <div class="card"><h4>حفظ البيانات</h4><button class="btn" id="save">حفظ</button> <button class="btn" id="reset">بداية جديدة</button></div>
        </div>
      </div>
      <div class="footer">
        <div>⏱️ كل ثانية = 1 “وحدة زمن” داخل اللعبة. كل 60 ثانية = يوم واحد.</div>
        <div id="day">اليوم 1</div>
      </div>
    </div>
  </div>

<script>
  // Telegram Mini App tweaks
  const tg = window.Telegram?.WebApp; if(tg){ try{ tg.ready(); tg.expand(); }catch(e){} }

  // ===== Game State =====
  const S = JSON.parse(localStorage.getItem('lemon_tycoon')||'null') || {
    money: 50,
    price: 5,
    quality: 1, // 1..10
    ads: 0,     // 0..10
    staff: 1,   // 1..10
    stock: 30,  // cups available
    visitorsPerMin: 10,
    day: 1,
    dayRevenue: 0,
    open: false
  };

  // ===== UI Binders =====
  const el = id=>document.getElementById(id);
  function render(){
    el('money').textContent = S.money.toFixed(0);
    el('price').textContent = S.price;
    el('price2').textContent = S.price;
    el('qualityBar').style.width = (S.quality*10)+'%';
    el('adsBar').style.width = (S.ads*10)+'%';
    el('staff').textContent = S.staff;
    el('stock').textContent = S.stock;
    el('visitors').textContent = visitorsPerMin().toFixed(0);
    el('serveRate').textContent = serveRate().toFixed(2);
    el('day').textContent = 'اليوم ' + S.day;
    el('dayRevenue').textContent = S.dayRevenue.toFixed(0);
    el('dayBar').style.width = Math.min(100, (S.dayRevenue/goalForDay())*100) + '%';
  }

  function save(){ localStorage.setItem('lemon_tycoon', JSON.stringify(S)); }
  function reset(){ localStorage.removeItem('lemon_tycoon'); location.reload(); }

  // ===== Core Sim =====
  function visitorsPerMin(){ return S.visitorsPerMin + S.ads*3 + (S.quality-1)*1.5; }
  function satisfaction(){
    // رضا يتأثر بالسعر مقابل الجودة
    const base = 50 + (S.quality-1)*5 + S.ads*2; // %
    const penalty = Math.max(0, (S.price-5)*4);   // كل زيادة سعر تقلل الرضا
    return Math.max(0, Math.min(95, base - penalty));
  }
  function serveRate(){ // cups per second depending on staff
    return 0.8 + (S.staff-1)*0.4; // عامل واحد ~0.8 كوب/ث
  }

  let tick=0; let loop=null; const DAY_LEN=60; // 60s = one day
  function start(){ if(loop) return; S.open=true; el('status').textContent='جاري البيع…'; loop=setInterval(step, 1000); }
  function stop(){ if(loop){ clearInterval(loop); loop=null; } S.open=false; el('status').textContent='متوقف'; }

  function step(){
    tick++;
    const visitors = visitorsPerMin()/60; // per second
    const willing = visitors * (satisfaction()/100);
    const canServe = Math.min(willing, serveRate());
    const orders = Math.min(S.stock, Math.floor(canServe* (1+Math.random()*0.2)) );
    if(orders>0){
      const revenue = orders * S.price;
      S.stock -= orders;
      S.money += revenue;
      S.dayRevenue += revenue;
    }
    if(tick % DAY_LEN === 0){ // new day
      S.day++;
      S.dayRevenue = 0;
    }
    render(); save();
  }

  function goalForDay(){ return 300 + (S.day-1)*80; }

  // ===== Buttons =====
  el('openShop').onclick = ()=>{ S.open ? stop() : start(); };
  el('incPrice').onclick = ()=>{ S.price = Math.min(50, S.price+1); render(); };
  el('decPrice').onclick = ()=>{ S.price = Math.max(1, S.price-1); render(); };
  el('upgradeQuality').onclick = ()=>{
    if(S.money>=20 && S.quality<10){ S.money-=20; S.quality++; render(); save(); haptic(); }
  };
  el('upgradeAds').onclick = ()=>{
    if(S.money>=30 && S.ads<10){ S.money-=30; S.ads++; render(); save(); haptic(); }
  };
  el('hire').onclick = ()=>{ if(S.money>=50 && S.staff<10){ S.money-=50; S.staff++; render(); save(); haptic(); } };
  el('buyStock').onclick = ()=>{ if(S.money>=20){ S.money-=20; S.stock+=20; render(); save(); haptic(); } };
  el('save').onclick = save; el('reset').onclick = reset;

  function haptic(){ try{ tg?.HapticFeedback?.impactOccurred('light'); }catch(e){} }

  // Auto-start if previously open
  render(); if(S.open) start();
</script>
</body>
</html>

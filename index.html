<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tile Match 3 — Telegram Mini App</title>
  <!-- Telegram Mini App SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#e8efe6; /* خلفية خفيفة */
      --card:#ffffff;
      --text:#2c2c2c;
      --accent:#2cc295; /* أخضر أنيق */
      --accent-2:#68a7ff; /* سماوي فاتح */
      --muted:#9aa1a7;
      --shadow:0 8px 24px rgba(0,0,0,.08);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: radial-gradient(1200px 600px at 50% -10%, #f5fff8, var(--bg));
      color:var(--text);
      -webkit-tap-highlight-color: transparent;
      display:flex; justify-content:center; align-items:center;
    }
    .app{width:min(920px, 100%); padding:16px}
    .frame{background:var(--card); border-radius:28px; box-shadow:var(--shadow); padding:14px; position:relative; overflow:hidden}

    /* Header */
    .header{display:flex; justify-content:space-between; align-items:center; padding:8px 10px 6px}
    .tag{background:linear-gradient(120deg, var(--accent), var(--accent-2)); color:#fff; padding:8px 14px; border-radius:999px; font-weight:700; box-shadow:0 6px 16px rgba(104,167,255,.25)}
    .coins{display:flex; align-items:center; gap:8px; background:#f3f7ff; color:#1b5cff; border-radius:999px; padding:8px 12px; font-weight:700}
    .coins i{filter: drop-shadow(0 4px 8px rgba(27,92,255,.25))}

    /* Tray */
    .tray{display:grid; grid-template-columns:repeat(7, 1fr); gap:10px; padding:12px; margin:6px 8px 8px; background:#f6faf6; border-radius:20px; border:1px solid #eef3ee}
    .slot{height:58px; border-radius:14px; background:#fff; box-shadow:inset 0 0 0 2px #edf0f2; display:flex; align-items:center; justify-content:center; font-size:30px}

    /* Board wrapper (gives perspective) */
    .board-wrap{position:relative; margin:6px 6px 12px; background:linear-gradient(155deg, #f6fff7, #eff7ff); border-radius:24px; border:1px solid #eef3f3; box-shadow:var(--shadow)}
    .board{position:relative; width:100%; aspect-ratio: 1/1; max-height:68vh; margin:auto; overflow:visible}

    /* Tile */
    .tile{position:absolute; width:88px; height:88px; max-width:15.5vw; max-height:15.5vw; display:flex; align-items:center; justify-content:center; font-size:40px; user-select:none; cursor:pointer;
      background:#fff; border-radius:18px; box-shadow:0 10px 20px rgba(0,0,0,.08), inset 0 0 0 2px #eaeef2; transition:transform .12s ease, box-shadow .12s ease, opacity .2s ease;}
    .tile:hover{transform:translateY(-2px)}
    .tile.disabled{opacity:.4; filter:saturate(.7); cursor:not-allowed}
    .tile.pop{animation:pop .24s ease}
    @keyframes pop{0%{transform:scale(.9)} 70%{transform:scale(1.06)} 100%{transform:scale(1)}}

    /* Toolbar */
    .toolbar{display:flex; gap:10px; justify-content:center; padding:12px}
    .btn{display:inline-flex; gap:8px; align-items:center; justify-content:center; padding:11px 14px; background:#fff; border:1px solid #edf1f4; border-radius:16px; box-shadow:var(--shadow); font-weight:700; cursor:pointer}
    .btn:active{transform:translateY(1px)}

    .footer{display:flex; justify-content:space-between; align-items:center; padding:8px 10px 16px; color:var(--muted)}
    .progress{height:8px; background:#ecf2ee; border-radius:999px; overflow:hidden}
    .progress > span{display:block; height:100%; width:0; background:linear-gradient(90deg, var(--accent), var(--accent-2))}

    @media (max-width:520px){
      .tile{width:70px; height:70px; font-size:32px}
      .slot{height:50px}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="frame">
      <div class="header">
        <div class="tag">المستوى <span id="level">20</span></div>
        <div class="coins"><i>💎</i><span id="coins">2000</span></div>
      </div>
      <div class="tray" id="tray"></div>

      <div class="board-wrap">
        <div class="board" id="board"></div>
      </div>

      <div class="toolbar">
        <button class="btn" id="btn-undo">↩︎ تراجع</button>
        <button class="btn" id="btn-hint">🧲 تلميح</button>
        <button class="btn" id="btn-shuffle">🔄 خلط</button>
      </div>

      <div class="footer">
        <div>باقي البلاطات: <b id="left">0</b></div>
        <div class="progress" style="width:45%"><span id="bar"></span></div>
        <div id="status">جاهز</div>
      </div>
    </div>
  </div>

  <script>
    // ===== Telegram Mini App bootstrapping =====
    const tg = window.Telegram?.WebApp;
    if (tg){
      try{ tg.ready(); tg.expand(); }catch(e){}
      const theme = tg.colorScheme === 'dark';
      if(theme){ document.documentElement.style.setProperty('--card', '#161a1e');
        document.documentElement.style.setProperty('--text', '#e8f0f2');
        document.documentElement.style.setProperty('--bg', '#0f1317');
        document.documentElement.style.setProperty('--muted', '#96a1aa');
        document.documentElement.style.setProperty('--shadow', '0 10px 24px rgba(0,0,0,.3)');
      }
    }

    // ===== Game Assets =====
    const ICONS = ['🍓','🍌','🍀','💧','⭐','🍎','🥥','🍉','🧁','💎'];
    const BOARD = document.getElementById('board');
    const TRAY = document.getElementById('tray');
    const LEFT = document.getElementById('left');
    const STATUS = document.getElementById('status');
    const BAR = document.getElementById('bar');

    const TRAY_MAX = 7; // لو اتملت بدون 3 متشابهين → خسارة
    const TRAY_SLOTS = Array.from({length:TRAY_MAX}, ()=>({el:null, id:null}));
    const STATE = {tiles:[], tray:[], history:[], solved:0};

    // ===== Layout helper: positions (x,y,z) لإحساس تكديس بسيط =====
    function generateLayout(){
      const layers = [
        {rows:3, cols:5, gap:6, offX:10, offY:8},
        {rows:2, cols:4, gap:6, offX:20, offY:18},
        {rows:1, cols:3, gap:6, offX:32, offY:32}
      ];
      const rect = BOARD.getBoundingClientRect();
      const tile = Math.min(rect.width, rect.height)/ (layers[0].cols + 2.2); // حجم نسبي
      const positions = [];
      let z=1;
      layers.forEach(L=>{
        for(let r=0;r<L.rows;r++){
          for(let c=0;c<L.cols;c++){
            positions.push({
              x: (c * (tile+L.gap)) + L.offX,
              y: (r * (tile+L.gap)) + L.offY,
              z: z
            });
          }
        }
        z++;
      });
      return {positions, size:tile};
    }

    function setupTray(){
      TRAY.innerHTML='';
      STATE.tray.length = 0;
      for(let i=0;i<TRAY_MAX;i++){
        const slot = document.createElement('div');
        slot.className='slot';
        TRAY.appendChild(slot);
        TRAY_SLOTS[i].el = slot;
        TRAY_SLOTS[i].id = null;
      }
    }

    function createDeck(kinds=ICONS.length, copies=3){
      // كل نوع له 3 نسخ (Triple match)
      const ids=[]; for(let i=0;i<kinds;i++){ for(let j=0;j<copies;j++) ids.push(i); }
      // ضاعف عشان نملأ أكثر من طبقة
      const deck = [...ids, ...ids, ...ids];
      // Shuffle
      for(let i=deck.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [deck[i],deck[j]]=[deck[j],deck[i]]; }
      return deck;
    }

    function drawBoard(){
      BOARD.innerHTML='';
      const {positions, size} = generateLayout();
      const deck = createDeck(Math.min(ICONS.length, 8), 3).slice(0, positions.length);
      STATE.tiles = [];
      for(let i=0;i<positions.length;i++){
        const id = deck[i % deck.length];
        const p = positions[i];
        const el = document.createElement('div');
        el.className='tile pop';
        el.style.left = p.x+'px';
        el.style.top = p.y+'px';
        el.style.zIndex = 100 + p.z; // بسيط
        el.style.width = el.style.height = size+'px';
        el.dataset.id = id;
        el.textContent = ICONS[id];
        el.addEventListener('click', ()=> onTileClick(el));
        BOARD.appendChild(el);
        STATE.tiles.push({el, id});
      }
      STATE.solved = 0;
      updateLeft();
      progress();
      STATUS.textContent='جاهز';
    }

    function updateLeft(){
      LEFT.textContent = STATE.tiles.filter(t=>!t.removed).length;
    }

    function haptic(type='impact'){ try{ tg?.HapticFeedback?.impactOccurred(type); }catch(e){} }

    function onTileClick(el){
      if(el.classList.contains('disabled')) return;
      const id = +el.dataset.id;
      // أضف للصينية
      if(STATE.tray.length >= TRAY_MAX){ lose(); return; }
      STATE.history.push({type:'pick', id, el});
      STATE.tray.push(id);
      placeInTray(id);
      el.classList.add('disabled');
      haptic('light');
      // لو 3 متشابهين → إزالة
      const count = STATE.tray.filter(x=>x===id).length;
      if(count === 3){
        clearTriples(id);
        haptic('rigid');
      }
      // فوز؟
      const remaining = STATE.tiles.filter(t=>!t.removed && !t.el.classList.contains('disabled')).length;
      if(remaining===0 && STATE.tray.length===0){ win(); }
      updateLeft();
      progress();
      if(STATE.tray.length>TRAY_MAX-1) lose();
    }

    function placeInTray(id){
      const idx = STATE.tray.length-1;
      const slot = TRAY_SLOTS[idx].el;
      slot.textContent = ICONS[id];
      TRAY_SLOTS[idx].id = id;
    }

    function clearTriples(id){
      // امسح من الصينية
      let removed = 0;
      for(let i=0;i<TRAY_SLOTS.length && removed<3;i++){
        if(TRAY_SLOTS[i].id===id){ TRAY_SLOTS[i].id=null; TRAY_SLOTS[i].el.textContent=''; removed++; }
      }
      STATE.tray = STATE.tray.filter(x=>x!==id);
      // أعد ترتيب العناصر الباقية بصريًا
      const rest = [...STATE.tray];
      TRAY_SLOTS.forEach(s=>{ s.id=null; s.el.textContent=''; });
      rest.forEach((rid,i)=>{ TRAY_SLOTS[i].id=rid; TRAY_SLOTS[i].el.textContent=ICONS[rid]; });
      // علّم البلاطات المختارة كمزالة
      STATE.tiles.forEach(t=>{
        if(!t.removed && t.el.classList.contains('disabled') && +t.el.dataset.id===id){ t.removed=true; t.el.style.opacity=.0; t.el.style.pointerEvents='none'; t.el.style.transform='scale(.9)'; }
      });
      STATE.solved += 3;
      STATUS.textContent = 'جمعت ثلاثي!';
    }

    function undo(){
      const last = STATE.history.pop();
      if(!last) return;
      if(last.type==='pick'){
        // أرجع من الصينية
        const idx = STATE.tray.lastIndexOf(last.id);
        if(idx>-1) STATE.tray.splice(idx,1);
        // امسح آخر خانة ممتلئة
        for(let i=TRAY_SLOTS.length-1;i>=0;i--){ if(TRAY_SLOTS[i].id!=null){ TRAY_SLOTS[i].id=null; TRAY_SLOTS[i].el.textContent=''; break; } }
        last.el.classList.remove('disabled');
        STATUS.textContent='تراجع';
      }
      progress();
    }

    function hint(){
      // دور على نوع ظاهر 3 مرات على الأقل ولم يُجمع بعد
      const visible = STATE.tiles.filter(t=>!t.removed && !t.el.classList.contains('disabled'));
      const freq = {};
      visible.forEach(t=>{ freq[t.id]=(freq[t.id]||0)+1; });
      let target = null; Object.keys(freq).forEach(k=>{ if(freq[k]>=3 && target==null) target=+k; });
      if(target==null){ STATUS.textContent='لا يوجد ثلاثي ظاهر'; haptic('selection'); return; }
      // لمع 3 بلاطات
      let glow = 0;
      visible.forEach(t=>{
        if(glow<3 && t.id===target){ t.el.animate([{boxShadow:'0 0 0 0 rgba(44,194,149,.0)'},{boxShadow:'0 0 0 6px rgba(44,194,149,.35)'}],{duration:380, direction:'alternate', iterations:2}); glow++; }
      });
      STATUS.textContent='هذا الثلاثي مناسب!';
    }

    function shuffle(){
      // أعد توزيع البلاطات غير الملتقطة
      const active = STATE.tiles.filter(t=>!t.removed && !t.el.classList.contains('disabled'));
      if(active.length<2){ STATUS.textContent='لا يوجد ما يُخلط'; return; }
      const rects = active.map(t=>({el:t.el}));
      // خلط بسيط للمواقع
      for(let i=rects.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [rects[i],rects[j]]=[rects[j],rects[i]]; }
      rects.forEach((r,i)=>{ r.el.style.transform='translateY(-3px)'; setTimeout(()=>{ r.el.style.left = (12 + (i%5)*18) + '%'; r.el.style.top = (8 + Math.floor(i/5)*18) + '%'; r.el.style.transform=''; }, 140); });
      STATUS.textContent='تم الخلط';
    }

    function progress(){
      const total = STATE.tiles.length;
      const cleared = STATE.tiles.filter(t=>t.removed).length;
      BAR.style.width = ((cleared/total)*100).toFixed(1)+'%';
    }

    function win(){ STATUS.textContent='فوز 🎉'; haptic('success'); }
    function lose(){ STATUS.textContent='خسرت — امتلأت الصينية'; haptic('error'); }

    // ===== Init =====
    setupTray();
    drawBoard();

    document.getElementById('btn-undo').onclick = undo;
    document.getElementById('btn-hint').onclick = hint;
    document.getElementById('btn-shuffle').onclick = shuffle;

    // إعادة ضبط اللوحة عند تغيير حجم الشاشة (لضبط المقاسات)
    let R;
    window.addEventListener('resize', ()=>{ clearTimeout(R); R=setTimeout(()=>{ drawBoard(); setupTray(); }, 220); });
  </script>
</body>
</html>

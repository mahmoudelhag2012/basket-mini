<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pizza Factory — 2D Tycoon (Mini App)</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{ --bg:#eef3fa; --card:#fff; --ink:#0f172a; --muted:#667085; --accent:#22c55e; --accent2:#3b82f6; --danger:#ef4444; --shadow:0 10px 24px rgba(0,0,0,.08); }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,"Cairo",sans-serif; background:radial-gradient(1100px 520px at 50% -10%, #ffffff, var(--bg)); color:var(--ink); -webkit-tap-highlight-color:transparent; display:flex; justify-content:center}
    .app{width:min(1020px,100%); padding:12px}
    .frame{background:var(--card); border-radius:24px; box-shadow:var(--shadow); overflow:hidden; border:1px solid #e8eef5}
    .top{display:flex; justify-content:space-between; align-items:center; gap:10px; padding:10px 14px; background:linear-gradient(90deg,var(--accent),var(--accent2)); color:#fff}
    .stats{display:flex; gap:10px; flex-wrap:wrap}
    .pill{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; background:rgba(255,255,255,.16)}
    .grid{display:grid; grid-template-columns:1.15fr .85fr; gap:10px; padding:10px}
    .panel{background:#f8fafc; border:1px solid #eef2f7; border-radius:18px; padding:10px}
    canvas{width:100%; aspect-ratio:16/9; background:linear-gradient(#f5fbff,#fff)}
    .row{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px 0}
    .btn{background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:10px 12px; box-shadow:var(--shadow); cursor:pointer; font-weight:700}
    .btn:active{transform:translateY(1px)}
    .meter{height:10px; border-radius:999px; background:#eef2f7; overflow:hidden}
    .meter>span{display:block; height:100%; background:linear-gradient(90deg,var(--accent),var(--accent2))}
    .note{color:var(--muted)}
    @media (max-width:780px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="app">
    <div class="frame">
      <div class="top">
        <b>Pizza Factory — شاشة واحدة مع عُمّال ومشتريين 👥🍕</b>
        <div class="stats">
          <div class="pill">💰 <b id="cash">0</b></div>
          <div class="pill">⚙️ سعة العامل <b id="cap">3</b></div>
          <div class="pill">🏃‍♂️ سرعة <b id="spd">1</b></div>
          <div class="pill">🔥 كومبو <b id="combo">x1.0</b></div>
        </div>
      </div>

      <div class="grid">
        <div class="panel">
          <h3>المصنع المصغّر (فرن واحد + مخزن بيتزا + كاونتر تقديم + طابور زبائن)</h3>
          <canvas id="cv" width="1000" height="562"></canvas>
          <div class="note" style="padding-top:6px">العامل يتحرك تلقائيًا: من الفرن → يلتقط حتى سعة الحمل → يسلّم على الكاونتر → يخدم أوتوماتيك الزبون الأول.</div>
        </div>
        <div class="panel">
          <h3>ترقيات (تأثير فوري على اللعب)</h3>
          <div class="row"><div>⏱️ سرعة الفرن</div><div><div class="meter" style="width:160px"><span id="ovenBar" style="width:20%"></span></div> <button class="btn" id="upOven">+ (120💰)</button></div></div>
          <div class="row"><div>🏃‍♂️ سرعة العامل</div><div><div class="meter" style="width:160px"><span id="speedBar" style="width:20%"></span></div> <button class="btn" id="upSpeed">+ (100💰)</button></div></div>
          <div class="row"><div>🧺 سعة الحمل</div><div><div class="meter" style="width:160px"><span id="capBar" style="width:20%"></span></div> <button class="btn" id="upCap">+ (150💰)</button></div></div>
          <div class="row"><div>📣 تسويق (يزود الزبائن)</div><div><div class="meter" style="width:160px"><span id="mkBar" style="width:0%"></span></div> <button class="btn" id="upMk">+ (130💰)</button></div></div>
          <div class="row"><div>حفظ</div><div><button class="btn" id="save">حفظ</button> <button class="btn" id="reset">بداية جديدة</button></div></div>
          <div class="note">فقاعات فوق الزبون تبين الطلب (🍕 × العدد) وشريط الصبر. الدفع يزيد مع الكومبو.</div>
        </div>
      </div>
    </div>
  </div>

<script>
const tg = window.Telegram?.WebApp; if(tg){ try{ tg.ready(); tg.expand(); }catch(e){} }
const cv = document.getElementById('cv'); const ctx = cv.getContext('2d'); const W=cv.width, H=cv.height;

// ====== STATE ======
const S = JSON.parse(localStorage.getItem('pizza_factory_2d')||'null') || {
  cash: 200,
  ovenLvl: 2,       // سرعة انتاج الفرن
  workerSpeed: 1,   // 1..10
  carryCap: 3,      // 1..10
  marketing: 0,     // 0..10
  combo: 1,
  dayRev: 0
};

const $=id=>document.getElementById(id);
function renderUI(){
  $('cash').textContent = S.cash.toFixed(0);
  $('cap').textContent = S.carryCap; $('spd').textContent=S.workerSpeed; $('combo').textContent='x'+S.combo.toFixed(1);
  $('ovenBar').style.width = (S.ovenLvl*10)+'%';
  $('speedBar').style.width = (S.workerSpeed*10)+'%';
  $('capBar').style.width = (S.carryCap*10)+'%';
  $('mkBar').style.width = (S.marketing*10)+'%';
}
function save(){ localStorage.setItem('pizza_factory_2d', JSON.stringify(S)); }
function reset(){ localStorage.removeItem('pizza_factory_2d'); location.reload(); }

// ====== WORLD POSITIONS (شبه إيزومتريك مبسّط) ======
const POS = {
  oven:{x:W*0.22, y:H-220},
  stack:{x:W*0.36, y:H-170},
  counter:{x:W*0.70, y:H-180},
  queueStart:{x:W*0.78, y:H-100}
};

// ====== ENTITIES ======
const oven = {timer:0, stock:0, limit:99};
const customers=[]; // {x,y,order,pat,served,leaving}
const worker = {x:POS.counter.x, y:POS.counter.y+20, carrying:0, target:null, state:'toOven'};

function ovenInterval(){ return Math.max(0.6, 2.2 - S.ovenLvl*0.18); }
function spawnRate(){ return 0.45 + S.marketing*0.08 + S.combo*0.02; } // per second
function patienceMax(){ return 6.5 + S.marketing*0.2; }

let spawnT=0, t=0;

function spawnCustomer(){
  const n = 1 + Math.floor(Math.random()*3); // 1..3
  customers.push({x:W+40,y:POS.queueStart.y-30-Math.random()*40, order:n, pat:patienceMax(), served:false, leaving:false});
}

function serveFromCounter(){
  // خدم الزبون الأول طالما فيه مخزون على الكاونتر
  const c = customers.find(c=>!c.served && !c.leaving);
  if(!c) return;
  const available = counter.stock||0;
  const give = Math.min(available, c.order);
  if(give>0){
    c.order -= give; counter.stock -= give; S.cash += give*10; S.dayRev += give*10; if(c.order===0){ c.served=true; S.combo=Math.min(5, S.combo+0.15); }
  }
}

const counter = {stock:0, limit:40};

// ====== AI: worker state machine ======
function workerSpeedPx(){ return (80 + S.workerSpeed*24); } // px/sec
function goTo(p){ worker.target={x:p.x, y:p.y}; }
function dist(ax,ay,bx,by){ const dx=ax-bx, dy=ay-by; return Math.hypot(dx,dy); }

function workerLogic(dt){
  // حدد هدف الحركة حسب الحالة
  if(worker.state==='toOven'){ goTo(POS.stack); if(dist(worker.x,worker.y,POS.stack.x,POS.stack.y)<10){ worker.state='pickup'; }}
  if(worker.state==='pickup'){
    // خُد من مخزون الفرن (stack)
    if(oven.stock>0 && worker.carrying < S.carryCap){ oven.stock--; worker.carrying++; }
    if(worker.carrying>=S.carryCap || oven.stock===0){ worker.state='toCounter'; }
  }
  if(worker.state==='toCounter'){ goTo(POS.counter); if(dist(worker.x,worker.y,POS.counter.x,POS.counter.y)<10){ worker.state='drop'; }}
  if(worker.state==='drop'){
    if(worker.carrying>0 && counter.stock<counter.limit){ counter.stock++; worker.carrying--; }
    if(worker.carrying===0){ worker.state='toOven'; }
  }

  // حركة فعلية
  if(worker.target){
    const d = dist(worker.x,worker.y,worker.target.x,worker.target.y);
    if(d>1){ const vx=(worker.target.x-worker.x)/d, vy=(worker.target.y-worker.y)/d; worker.x += vx*workerSpeedPx()*dt; worker.y += vy*workerSpeedPx()*dt; }
  }
}

// ====== LOOP ======
function step(dt){
  t+=dt; spawnT -= dt; if(spawnT<=0){ spawnT = 1/spawnRate(); spawnCustomer(); }

  // oven produce
  oven.timer -= dt; if(oven.timer<=0){ oven.timer = ovenInterval(); if(oven.stock<oven.limit) oven.stock++; }

  // customers move & patience
  customers.forEach((c,i)=>{
    // move toward queue spots left of counter
    const idx = customers.filter(z=>!z.served && !z.leaving && customers.indexOf(z)<=i).length-1;
    const targetX = POS.queueStart.x - idx*40;
    if(!c.served && !c.leaving && c.x>targetX){ c.x -= 90*dt; }

    if(!c.served){ c.pat -= dt; if(c.pat<=0){ c.leaving=true; S.combo=Math.max(1, S.combo-0.5); } }
    if(c.served){ c.x += 160*dt; }
    if(c.leaving){ c.x += 120*dt; }
  });

  // serve customers if stock exists
  serveFromCounter();

  // worker logic
  workerLogic(dt);

  // cleanup
  for(let i=customers.length-1;i>=0;i--){ const c=customers[i]; if(c.x<-60 || c.x>W+60){ customers.splice(i,1); } }
}

function draw(){
  ctx.clearRect(0,0,W,H);
  // floor grid
  ctx.strokeStyle='#eef2f7'; ctx.lineWidth=1; for(let x=0;x<W;x+=40){ ctx.beginPath(); ctx.moveTo(x,H-260); ctx.lineTo(x,H); ctx.stroke(); } for(let y=H-260;y<H;y+=40){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke(); }

  // oven block
  ctx.fillStyle='#3b82f6'; ctx.fillRect(POS.oven.x-60, POS.oven.y-40, 120, 80);
  ctx.fillStyle='#1d4ed8'; ctx.fillRect(POS.oven.x-46, POS.oven.y-18, 92, 36); // dark belt
  ctx.fillStyle='#0ea5e9'; ctx.font='16px system-ui'; ctx.fillText('الفرن', POS.oven.x-16, POS.oven.y-50);

  // stack near oven (cylinder of pizzas)
  drawStack(POS.stack.x, POS.stack.y, oven.stock, '🍕');

  // counter block
  ctx.fillStyle='#ef4444'; ctx.fillRect(POS.counter.x-70, POS.counter.y-30, 180, 80);
  ctx.fillStyle='#b91c1c'; ctx.fillRect(POS.counter.x-70, POS.counter.y+34, 180, 8);
  ctx.fillStyle='#111'; ctx.font='16px system-ui'; ctx.fillText('كاونتر', POS.counter.x-20, POS.counter.y-40);
  // counter stock
  drawStack(POS.counter.x+80, POS.counter.y+16, counter.stock, '🍕', true);

  // queue label
  ctx.fillStyle='#0ea5e9'; ctx.fillText('الطابور', POS.queueStart.x-20, POS.queueStart.y-60);

  // customers
  customers.forEach((c,idx)=>{
    // body
    ctx.fillStyle='#0ea5e9'; ctx.beginPath(); ctx.arc(c.x, c.y, 16, 0, Math.PI*2); ctx.fill(); // head
    ctx.fillStyle='#64748b'; ctx.fillRect(c.x-12, c.y+2, 24, 22); // body
    // bubble: order
    const bx=c.x-18, by=c.y-46; ctx.fillStyle='rgba(255,255,255,.95)'; ctx.strokeStyle='#d1d8e2'; ctx.lineWidth=2; ctx.fillRect(bx,by,42,24); ctx.strokeRect(bx,by,42,24);
    ctx.fillStyle='#111'; ctx.font='18px system-ui'; ctx.fillText('🍕', c.x-14, c.y-28); ctx.fillText(c.order.toString(), c.x+2, c.y-28);
    // patience bar
    const p=c.pat/patienceMax(); ctx.fillStyle='#e2e8f0'; ctx.fillRect(c.x-20,c.y-22,40,5); ctx.fillStyle=p>0.5?'#22c55e':(p>0.25?'#f59e0b':'#ef4444'); ctx.fillRect(c.x-20,c.y-22,40*p,5);
    if(c.served){ ctx.fillStyle='#22c55e'; ctx.fillText('✓', c.x-4, c.y-54); }
    if(c.leaving && !c.served){ ctx.fillStyle='#ef4444'; ctx.fillText('✗', c.x-4, c.y-54); }
  });

  // worker (with stack of pizzas carried)
  ctx.fillStyle='#f97316'; ctx.beginPath(); ctx.arc(worker.x, worker.y-16, 18, 0, Math.PI*2); ctx.fill(); // head
  ctx.fillStyle='#1f2937'; ctx.fillRect(worker.x-14, worker.y-6, 28, 28); // torso
  // carried pizzas
  for(let i=0;i<worker.carrying;i++){ drawSmallPizza(worker.x, worker.y-12 - i*10); }
}

function drawStack(x,y,count,emoji,small){
  const height = Math.min(count, 10); // visual slices
  for(let i=0;i<height;i++){
    if(small) drawSmallPizza(x, y - i*8); else drawPizza(x, y - i*10);
  }
}
function drawPizza(x,y){
  // simple disc with emoji to feel like pizza stack
  ctx.fillStyle='#fef3c7'; ctx.beginPath(); ctx.ellipse(x,y,22,8,0,0,Math.PI*2); ctx.fill(); ctx.strokeStyle='#b45309'; ctx.stroke(); ctx.font='16px system-ui'; ctx.fillStyle='#111'; ctx.fillText('🍕', x-8, y+6);
}
function drawSmallPizza(x,y){ ctx.fillStyle='#fef3c7'; ctx.beginPath(); ctx.ellipse(x,y,12,5,0,0,Math.PI*2); ctx.fill(); ctx.strokeStyle='#b45309'; ctx.stroke(); ctx.font='12px system-ui'; ctx.fillStyle='#111'; ctx.fillText('🍕', x-6, y+4); }

let last=0; function loop(now){ const dt=(now-last)/1000||0.016; last=now; step(dt); draw(); requestAnimationFrame(loop); }
requestAnimationFrame(loop);

// ====== UI Buttons ======
$('upOven').onclick = ()=>{ if(S.cash>=120){ S.cash-=120; S.ovenLvl++; renderUI(); save(); haptic(); } };
$('upSpeed').onclick = ()=>{ if(S.cash>=100){ S.cash-=100; S.workerSpeed++; renderUI(); save(); haptic(); } };
$('upCap').onclick = ()=>{ if(S.cash>=150){ S.cash-=150; S.carryCap++; renderUI(); save(); haptic(); } };
$('upMk').onclick = ()=>{ if(S.cash>=130){ S.cash-=130; S.marketing++; renderUI(); save(); haptic(); } };
$('save').onclick = save; $('reset').onclick = reset;

function haptic(){ try{ tg?.HapticFeedback?.impactOccurred('light'); }catch(e){} }
renderUI();
</script>
</body>
</html>

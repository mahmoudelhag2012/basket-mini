<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Basket Blitz — Phaser 2.5D</title>
<script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.js"></script>
<style>
  :root{--gold1:#ffd46a;--gold2:#ffb724}
  html,body{margin:0;height:100%;background:#0b0f18;font-family:system-ui,Arial}
  #game{max-width:560px;margin:0 auto;display:block}
  .btn{max-width:560px;margin:8px auto 16px;background:linear-gradient(180deg,var(--gold1),var(--gold2));color:#1b1100;border:0;border-radius:14px;padding:12px 14px;font-weight:800;box-shadow:0 10px 20px #0008}
</style>
</head>
<body>

<canvas id="game"></canvas>
<button class="btn">اسحب للأمام للتصويب 🏀 (Flick Forward)</button>

<script>
/* ------------------ Embedded SVG assets (Data URI) ------------------ */
// ملعب (سماء + أرضية خشب + حلقة منتصف)
const COURT_SVG = `
<svg width="560" height="720" viewBox="0 0 560 720" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <linearGradient id="sky" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0" stop-color="#4da0ff"/>
      <stop offset="1" stop-color="#74e1ff"/>
    </linearGradient>
    <radialGradient id="spot" cx="50%" cy="16%" r="30%">
      <stop offset="0" stop-color="#fff" stop-opacity=".35"/>
      <stop offset="1" stop-color="#fff" stop-opacity="0"/>
    </radialGradient>
    <linearGradient id="wood" x1="0" x2="1">
      <stop offset="0" stop-color="#a86c3a"/>
      <stop offset="1" stop-color="#d79a5f"/>
    </linearGradient>
  </defs>
  <rect width="560" height="720" fill="#0b0f18"/>
  <rect x="40" y="80" width="480" height="560" rx="24" fill="url(#sky)"/>
  <ellipse cx="280" cy="160" rx="180" ry="30" fill="url(#spot)"/>
  <!-- أرضية خشب بيضاوية -->
  <g transform="translate(40,80)">
    <ellipse cx="240" cy="420" rx="220" ry="90" fill="#000" opacity=".22"/>
    <clipPath id="cut">
      <ellipse cx="240" cy="410" rx="220" ry="90"/>
    </clipPath>
    <g clip-path="url(#cut)">
      <rect x="20" y="320" width="440" height="180" fill="url(#wood)"/>
      <g opacity=".35">
        <rect x="20" y="320" width="2" height="180" fill="#000"/>
        <rect x="36" y="320" width="2" height="180" fill="#000"/>
        <rect x="52" y="320" width="2" height="180" fill="#000"/>
        <rect x="68" y="320" width="2" height="180" fill="#000"/>
        <rect x="84" y="320" width="2" height="180" fill="#000"/>
        <rect x="100" y="320" width="2" height="180" fill="#000"/>
        <rect x="116" y="320" width="2" height="180" fill="#000"/>
        <rect x="132" y="320" width="2" height="180" fill="#000"/>
        <rect x="148" y="320" width="2" height="180" fill="#000"/>
        <rect x="164" y="320" width="2" height="180" fill="#000"/>
        <rect x="180" y="320" width="2" height="180" fill="#000"/>
        <rect x="196" y="320" width="2" height="180" fill="#000"/>
        <rect x="212" y="320" width="2" height="180" fill="#000"/>
        <rect x="228" y="320" width="2" height="180" fill="#000"/>
        <rect x="244" y="320" width="2" height="180" fill="#000"/>
        <rect x="260" y="320" width="2" height="180" fill="#000"/>
        <rect x="276" y="320" width="2" height="180" fill="#000"/>
        <rect x="292" y="320" width="2" height="180" fill="#000"/>
        <rect x="308" y="320" width="2" height="180" fill="#000"/>
        <rect x="324" y="320" width="2" height="180" fill="#000"/>
        <rect x="340" y="320" width="2" height="180" fill="#000"/>
        <rect x="356" y="320" width="2" height="180" fill="#000"/>
        <rect x="372" y="320" width="2" height="180" fill="#000"/>
        <rect x="388" y="320" width="2" height="180" fill="#000"/>
        <rect x="404" y="320" width="2" height="180" fill="#000"/>
      </g>
    </g>
    <ellipse cx="240" cy="400" rx="120" ry="48" fill="none" stroke="#ffffff66" stroke-width="6"/>
  </g>
</svg>
`.trim();

const HOOP_SVG = `
<svg width="420" height="300" viewBox="0 0 420 300" xmlns="http://www.w3.org/2000/svg">
  <!-- لوح -->
  <rect x="95" y="30" width="230" height="26" rx="12" fill="#eaf0ff"/>
  <rect x="120" y="56" width="14" height="110" rx="7" fill="#eaf0ff"/>
  <rect x="286" y="56" width="14" height="110" rx="7" fill="#eaf0ff"/>
  <!-- Rim -->
  <path d="M140 170 Q210 196 280 170" stroke="#ff6a2e" stroke-width="18" fill="none" stroke-linecap="round"/>
  <!-- Net -->
  <g id="net" stroke="#fff" stroke-width="3" opacity=".95">
    <path d="M154 170 L210 250"/>
    <path d="M168 170 L224 250"/>
    <path d="M182 170 L238 250"/>
    <path d="M196 170 L252 246"/>
    <path d="M210 170 L266 238"/>
    <path d="M224 170 L254 228"/>
    <path d="M238 170 L242 220"/>
  </g>
</svg>
`.trim();

const BALL_SVG = `
<svg width="160" height="160" viewBox="0 0 160 160" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <radialGradient id="g1" cx="35%" cy="35%" r="30%">
      <stop offset="0" stop-color="#ffbe8a"/>
      <stop offset="1" stop-color="#ff9247"/>
    </radialGradient>
    <radialGradient id="g2" cx="68%" cy="72%" r="60%">
      <stop offset="0" stop-color="#ff6e22"/>
      <stop offset="1" stop-color="#c94a10"/>
    </radialGradient>
  </defs>
  <circle cx="80" cy="80" r="78" fill="url(#g2)"/>
  <circle cx="56" cy="56" r="32" fill="url(#g1)"/>
  <g stroke="rgba(0,0,0,.45)" stroke-width="6" fill="none">
    <path d="M20,78 a60,60 0 0 0 120,0"/>
    <path d="M20,78 a60,60 0 0 1 120,0"/>
  </g>
</svg>
`.trim();

/* ------------------ Phaser setup ------------------ */
const DPR = Math.max(1, window.devicePixelRatio || 1);
const GAME_W = 560, GAME_H = 720;

const config = {
  type: Phaser.AUTO,
  width: GAME_W,
  height: GAME_H,
  parent: null,
  canvas: document.getElementById('game'),
  backgroundColor: '#0b0f18',
  physics: {
    default: 'arcade',
    arcade: { gravity: { y: 900 }, debug: false }
  },
  scene: { preload, create, update }
};

const game = new Phaser.Game(config);

let court, hoop, ball, rimL, rimR, rimY, guide, aiming=false, pointerStart=null;
let score=0, combo=1, level=1, timeLeft=60, lastTime=0, swishArmed=false, hitRim=false;

function preload(){
  // load SVGs from data URIs
  this.textures.addBase64('court', 'data:image/svg+xml;utf8,'+encodeURIComponent(COURT_SVG));
  this.textures.addBase64('hoop',  'data:image/svg+xml;utf8,'+encodeURIComponent(HOOP_SVG));
  this.textures.addBase64('ball',  'data:image/svg+xml;utf8,'+encodeURIComponent(BALL_SVG));
}

function create(){
  const s = this;

  // Court & hoop
  court = s.add.image(GAME_W/2, GAME_H/2, 'court').setOrigin(0.5).setDisplaySize(GAME_W, GAME_H);
  hoop  = s.add.image(GAME_W/2, 240, 'hoop').setScale(0.68).setDepth(10);

  // Rim info (للتصادم والسكور)
  rimY = hoop.y + 100;                        // ارتفاع الحافة تقريبًا
  const inner = 150;                          // فتحة السلة
  rimL = new Phaser.Math.Vector2(hoop.x - inner/2, rimY-4);
  rimR = new Phaser.Math.Vector2(hoop.x + inner/2, rimY-4);

  // كرة (فيزياء Arcade)
  ball = s.physics.add.image(GAME_W/2, 560, 'ball').setCircle(78).setScale(0.23);
  ball.setBounce(0.45).setCollideWorldBounds(false).setDepth(5);

  // Parallax spotlight لطافة
  s.tweens.add({ targets: hoop, angle: {from:-2, to:2}, duration: 1400, yoyo: true, repeat: -1, ease: 'sine.inOut' });

  // السلة تتحرك يمين/شمال (صعوبة = مستوى)
  moveHoop(s);

  // مسار متوقّع
  guide = s.add.graphics({ lineStyle: { width: 2, color: 0xffffff, alpha: 0.45 }, depth: 20 });

  // إدخال: فليك للأمام
  s.input.on('pointerdown', p=>{
    if(!ball.body.blocked && !aiming && ball.body.speed<10){
      const dx=p.x-ball.x, dy=p.y-ball.y;
      if(Math.hypot(dx,dy)<80) { aiming=true; pointerStart=new Phaser.Math.Vector2(p.x,p.y); drawGuide(p); }
    }
  });
  s.input.on('pointermove', p=> { if(aiming) drawGuide(p); });
  s.input.on('pointerup',    p=> {
    if(!aiming) return;
    aiming=false; guide.clear();
    // فليك: متجه من بداية السحب لنهايته
    const dx=(p.x-pointerStart.x), dy=(p.y-pointerStart.y);
    const len=Math.min(260, Math.hypot(dx,dy));
    const ang=Math.atan2(dy,dx);
    const boost = Math.min(1.6, 120/Math.max(40, (performance.now() - p.downTime || 80)));
    const sp = len*3.2*boost;
    ball.setVelocity(Math.cos(ang)*sp, Math.sin(ang)*sp - 200); // -200 لرفعة للأعلى
    swishArmed=false; hitRim=false;
  });

  lastTime = s.time.now;
}

function moveHoop(s){
  s.tweens.add({
    targets: hoop,
    x: { from: 120, to: GAME_W-120 },
    duration: Math.max(2400 - level*120, 1200),
    yoyo: true, repeat: -1, ease: 'sine.inOut',
    onUpdate: ()=>{ // حدّث مواقع الحافة مع الحركة
      rimY = hoop.y + 100;
      const inner=150;
      rimL.set(hoop.x - inner/2, rimY-4);
      rimR.set(hoop.x + inner/2, rimY-4);
    }
  });
}

function drawGuide(p){
  guide.clear();
  const dx=(p.x-pointerStart.x), dy=(p.y-pointerStart.y);
  const len=Math.min(260, Math.hypot(dx,dy));
  const ang=Math.atan2(dy,dx);
  const sp=len*0.18;
  let vx=Math.cos(ang)*sp, vy=Math.sin(ang)*sp - 3;
  let px=ball.x, py=ball.y;
  for(let i=0;i<60;i++){
    vx*=0.996; vy+=0.5;
    px+=vx*3; py+=vy*3;
    if(i===0) guide.beginPath(), guide.moveTo(ball.x, ball.y);
    guide.lineTo(px,py);
  }
  guide.strokePath();
}

function update(time, delta){
  const s = this;
  const dt = Math.min(32, delta);

  // جاذبية إضافية بسيطة (شكل 2.5D)
  if(ball.y>GAME_H+120) resetBall();

  // تصادم بسيط مع طرفي الحافة (ارتداد)
  collideRim(ball, rimL);
  collideRim(ball, rimR);

  // تسليح الـswish لما يعدّي مستوى الحافة إلى أسفل
  if(ball.body.velocity.y < 0 && ball.y < rimY-12) swishArmed = true;

  // سكور: لو داخل الفتحة ومن غير لمس
  if(swishArmed && ball.body.velocity.y > 0 && ball.y > rimY &&
     ball.x > rimL.x && ball.x < rimR.x && !hitRim){
    goal(true);
  }

  // عدّاد وقت بسيط
  timeLeft -= dt/1000;
  if(timeLeft<=0){ timeLeft=60; score=0; combo=1; level=1; resetBall(); moveHoop(s); }
}

/* ------------------ Helpers ------------------ */
function collideRim(ball, p){
  const dx=ball.x-p.x, dy=ball.y-p.y, rr=22; // نصف قطر افتراضي
  const d=Math.hypot(dx,dy);
  if(d<rr && ball.body.velocity.y>0){
    hitRim=true;
    const nx=dx/d, ny=dy/d;
    // ادفع الكرة للخارج واعكس مركبات السرعة على النورمال
    ball.x = p.x + nx*rr; ball.y = p.y + ny*rr;
    const dot = ball.body.velocity.x*nx + ball.body.velocity.y*ny;
    ball.setVelocity(ball.body.velocity.x - 1.8*dot*nx,
                     ball.body.velocity.y - 1.8*dot*ny);
  }
}

function goal(swish){
  const base = swish? 3:2;
  score += base*combo;
  combo = Math.min

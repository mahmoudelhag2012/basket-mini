<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pizza Factory â€” Isometric + Conveyor + Levels</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{ --bg:#eaf2ff; --card:#fff; --ink:#0f172a; --muted:#6b7280; --accent:#22c55e; --accent2:#3b82f6; --danger:#ef4444; --shadow:0 10px 28px rgba(0,0,0,.08); }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,"Cairo",sans-serif; background:radial-gradient(1000px 540px at 50% -10%, #ffffff, var(--bg)); color:var(--ink); display:flex; justify-content:center}
    .app{width:min(1040px,100%); padding:12px}
    .frame{background:var(--card); border-radius:24px; box-shadow:var(--shadow); overflow:hidden; border:1px solid #e8eef5}
    .top{display:flex; justify-content:space-between; align-items:center; gap:10px; padding:10px 14px; background:linear-gradient(90deg,var(--accent),var(--accent2)); color:#fff}
    .stats{display:flex; gap:10px; flex-wrap:wrap}
    .pill{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; background:rgba(255,255,255,.16); font-weight:700}
    .grid{display:grid; grid-template-columns:1.2fr .8fr; gap:10px; padding:10px}
    .panel{background:#f8fafc; border:1px solid #eef2f7; border-radius:18px; padding:10px}
    .panel canvas{
      display:block; margin-inline:auto; width:100%; max-width:1000px;
      aspect-ratio:16/9; height:auto; background:linear-gradient(#f5fbff,#fff); border-radius:12px;
    }
    .row{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px 0}
    .btn{background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:10px 12px; box-shadow:var(--shadow); cursor:pointer; font-weight:700}
    .btn:active{transform:translateY(1px)}
    .meter{height:10px; border-radius:999px; background:#eef2f7; overflow:hidden}
    .meter>span{display:block; height:100%; background:linear-gradient(90deg,var(--accent),var(--accent2))}
    .toolbar{display:flex; gap:8px; flex-wrap:wrap; padding:8px}
    .iconbtn{display:inline-flex; align-items:center; gap:8px; padding:8px 10px; background:#fff; border:1px solid #e5e7eb; border-radius:12px; box-shadow:var(--shadow); font-weight:700}
    .hud{display:flex; justify-content:space-between; align-items:center; color:var(--muted); padding:6px 10px}
    .overlay{position:fixed; inset:0; background:rgba(15,23,42,.66); display:none; place-items:center; z-index:50}
    .card{background:#fff; border-radius:18px; padding:16px; width:min(520px,90%); box-shadow:var(--shadow); text-align:center}
    .card h2{margin:8px 0}
    @media (max-width:780px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="app">
    <div class="frame">
      <div class="top">
        <b>Pizza Factory â€” Ø¥ÙŠØ²ÙˆÙ…ØªØ±ÙŠÙƒ + Ø³ÙŠÙˆØ± + Ù…Ø±Ø§Ø­Ù„</b>
        <div class="stats">
          <div class="pill">ğŸ’° <b id="cash">0</b></div>
          <div class="pill">â­ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ <b id="level">1</b></div>
          <div class="pill">ğŸ¯ Ø§Ù„Ù‡Ø¯Ù <b id="goal">0</b></div>
          <div class="pill">â³ Ø§Ù„ÙˆÙ‚Øª <b id="time">00:00</b></div>
        </div>
      </div>

      <div class="grid">
        <div class="panel">
          <h3>Ø§Ù„Ù…Ù„Ø¹Ø¨ (Ø¥ÙŠØ²ÙˆÙ…ØªØ±ÙŠÙƒ Ø¨Ø³ÙŠØ· + Conveyor Ù…ØªØ­Ø±Ùƒ + Sprites)</h3>
          <canvas id="cv"></canvas>
          <div class="toolbar">
            <button class="iconbtn" id="btnTut">ğŸ“˜ Ø´Ø±Ø­ Ø³Ø±ÙŠØ¹</button>
            <button class="iconbtn" id="btnMute">ğŸ”Š ØµÙˆØª</button>
            <button class="iconbtn" id="btnRestart">ğŸ” Ø¥Ø¹Ø§Ø¯Ø©</button>
          </div>
        </div>
        <div class="panel">
          <h3>ØªØ±Ù‚ÙŠØ§Øª (ØªØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø±Ø§ÙÙŠÙƒ ÙˆØ§Ù„Ø­Ø±ÙƒØ© ÙÙˆØ±Ù‹Ø§)</h3>
          <div class="row"><div>â±ï¸ Ø³Ø±Ø¹Ø© Ø§Ù„ÙØ±Ù†</div><div><div class="meter" style="width:160px"><span id="ovenBar" style="width:20%"></span></div> <button class="btn" id="upOven">+ (120ğŸ’°)</button></div></div>
          <div class="row"><div>ğŸƒâ€â™‚ï¸ Ø³Ø±Ø¹Ø© Ø§Ù„Ø¹Ø§Ù…Ù„</div><div><div class="meter" style="width:160px"><span id="speedBar" style="width:20%"></span></div> <button class="btn" id="upSpeed">+ (100ğŸ’°)</button></div></div>
          <div class="row"><div>ğŸ§º Ø³Ø¹Ø© Ø§Ù„Ø­Ù…Ù„</div><div><div class="meter" style="width:160px"><span id="capBar" style="width:20%"></span></div> <button class="btn" id="upCap">+ (150ğŸ’°)</button></div></div>
          <div class="row"><div>ğŸ“£ ØªØ³ÙˆÙŠÙ‚ (ÙŠØ²ÙˆØ¯ Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†)</div><div><div class="meter" style="width:160px"><span id="mkBar" style="width:0%"></span></div> <button class="btn" id="upMk">+ (130ğŸ’°)</button></div></div>
          <div class="row"><div>Ø­ÙØ¸</div><div><button class="btn" id="save">Ø­ÙØ¸</button> <button class="btn" id="reset">Ø¨Ø¯Ø§ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</button></div></div>
        </div>
      </div>

      <div class="hud">
        <div>ğŸšš Ø§Ù„Ø³ÙŠØ± ÙŠÙ†Ù‚Ù„ Ø§Ù„Ø¹Ø¬ÙŠÙ† â€” Ø§Ù„Ø¹Ø§Ù…Ù„ ÙŠØ­Ù…Ù„ Ù…Ù† Ø§Ù„Ù…Ø®Ø²Ù† ÙˆÙŠØ³Ù„Ù‘Ù… Ø¹Ù„Ù‰ Ø§Ù„ÙƒØ§ÙˆÙ†ØªØ±</div>
        <div>ğŸµ Ø£ØµÙˆØ§Øª Ø®ÙÙŠÙØ© Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ù†ØªØ§Ø¬ ÙˆØ§Ù„ØªØ³Ù„ÙŠÙ…</div>
      </div>
    </div>
  </div>

  <div class="overlay" id="overlay">
    <div class="card">
      <h2 id="ovTitle">Ø´Ø±Ø­ Ø³Ø±ÙŠØ¹</h2>
      <p id="ovBody">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø¨ÙˆÙ† Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø·Ù„Ø¨. Ø§Ù„Ø³ÙŠÙˆØ± ØªÙ†Ù‚Ù„ Ø§Ù„Ø¹Ø¬ÙŠÙ† â†’ Ø§Ù„ÙØ±Ù† ÙŠÙ†ØªØ¬ â†’ Ø§Ù„Ø¹Ø§Ù…Ù„ ÙŠØ­Ù…Ù„ ÙˆÙŠØ³Ù„Ù‘Ù…. Ø­Ù‚Ù‘Ù‚ Ø§Ù„Ù‡Ø¯Ù Ù‚Ø¨Ù„ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙˆÙ‚Øª!</p>
      <button class="btn" id="ovBtn">Ø­Ø³Ù†Ø§Ù‹</button>
    </div>
  </div>

<script>
// Telegram
const tg = window.Telegram?.WebApp; if(tg){ try{ tg.ready(); tg.expand(); }catch(e){} }

// Canvas + HiDPI scaling (Ù…Ø­Ø§Ø°Ø§Ø© Ùˆ16:9)
const cv = document.getElementById('cv');
const ctx = cv.getContext('2d');
function scaleCanvas(){
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  const rect = cv.getBoundingClientRect();
  const cssW = Math.max(640, Math.floor(rect.width  || 960));
  const cssH = Math.max(360, Math.floor(rect.height || cssW * 9/16));
  cv.width  = Math.floor(cssW * dpr);
  cv.height = Math.floor(cssH * dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
new ResizeObserver(scaleCanvas).observe(cv);
scaleCanvas();
const W = () => (cv.getBoundingClientRect().width  || 960);
const H = () => (cv.getBoundingClientRect().height || 540);

// Helpers
function shadow(f){ ctx.save(); ctx.shadowColor='rgba(0,0,0,.18)'; ctx.shadowBlur=12; ctx.shadowOffsetY=6; f(); ctx.restore(); }
function grad(x0,y0,x1,y1,c0,c1){ const g=ctx.createLinearGradient(x0,y0,x1,y1); g.addColorStop(0,c0); g.addColorStop(1,c1); return g; }

// Simple Sprites (SVG -> Bitmap) + fallback
const SPRITES = {
  worker:`<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64' viewBox='0 0 64 64'>
    <defs><linearGradient id='b' x1='0' x2='1'><stop offset='0' stop-color='#60a5fa'/><stop offset='1' stop-color='#2563eb'/></linearGradient></defs>
    <circle cx='32' cy='22' r='12' fill='#f97316'/>
    <rect x='18' y='28' width='28' height='24' rx='6' fill='url(#b)'/>
    <rect x='16' y='16' width='18' height='6' rx='3' fill='#1d4ed8'/><rect x='34' y='18' width='10' height='4' fill='#1d4ed8'/>
  </svg>`,
  customer:`<svg xmlns='http://www.w3.org/2000/svg' width='56' height='56' viewBox='0 0 56 56'>
    <circle cx='28' cy='18' r='10' fill='#94a3b8'/><rect x='16' y='24' width='24' height='20' rx='6' fill='#1f2937'/>
  </svg>`,
  oven:`<svg xmlns='http://www.w3.org/2000/svg' width='96' height='64' viewBox='0 0 96 64'>
    <defs><linearGradient id='o' x1='0' x2='1'><stop offset='0' stop-color='#60a5fa'/><stop offset='1' stop-color='#2563eb'/></linearGradient></defs>
    <rect x='2' y='8' width='92' height='48' rx='10' fill='url(#o)'/><rect x='12' y='22' width='72' height='20' rx='6' fill='#1d4ed8'/>
  </svg>`,
  pizza:`<svg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 40 40'>
    <ellipse cx='20' cy='24' rx='16' ry='6' fill='#f59e0b' stroke='#b45309' stroke-width='2'/><text x='12' y='28' font-size='16'>ğŸ•</text>
  </svg>`
};
let spritesReady=false; const GFX={};
async function svgToBitmap(svg){ try{ const blob=new Blob([svg],{type:'image/svg+xml'}); const url=URL.createObjectURL(blob); const img=new Image(); img.decoding='async'; img.src=url; await img.decode(); const bmp=await createImageBitmap(img); URL.revokeObjectURL(url); return bmp; }catch{ return null; } }
(async()=>{ for(const k in SPRITES){ GFX[k]=await svgToBitmap(SPRITES[k]); } spritesReady=true; })();

// Sound (bleeps)
let audioCtx=null, muted=false;
function beep(freq=880,dur=0.06,type='triangle',gain=0.03){
  if(muted) return; if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type=type; o.frequency.value=freq; g.gain.value=gain;
  o.connect(g).connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+dur);
}

// Levels
const LEVELS=[
  {goal:200,time:60, spawn:0.5, order:[1,2], oven:2, speed:1, cap:3, mk:0},
  {goal:350,time:70, spawn:0.65, order:[1,3], oven:3, speed:1, cap:3, mk:1},
  {goal:500,time:80, spawn:0.8, order:[2,3], oven:3, speed:2, cap:4, mk:1},
  {goal:700,time:90, spawn:1.0, order:[2,3], oven:4, speed:2, cap:5, mk:2},
];

// State
const S = JSON.parse(localStorage.getItem('pf_iso_levels')||'null') || {level:1, cash:200, ovenLvl:2, workerSpeed:1, carryCap:3, marketing:0};
let timeLeft=LEVELS[S.level-1].time, goal=LEVELS[S.level-1].goal;

// Isometric coords (Ø£ÙˆÙØ³Øª Ø¢Ù…Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¥Ø·Ø§Ø±)
const iso = (x,y)=>({ X: x - y + W()*0.33, Y: (x + y) * 0.50 + H()*0.38 });

// Entities
const oven={timer:0, stock:0, limit:99};
const counter={stock:0, limit:40};
const worker={x:iso(240,160).X, y:iso(240,160).Y, carrying:0, target:null, state:'toStack'};
const customers=[]; // {isoX,isoY,scrX,scrY,order,pat,served,leaving}

// Rates
function ovenInterval(){ return Math.max(0.6, 2.2 - S.ovenLvl*0.18); }
function spawnRate(){ return LEVELS[S.level-1].spawn + S.marketing*0.05; }
function patienceMax(){ return 6.5 + S.marketing*0.2; }
let spawnT=1/spawnRate();

// HUD & overlay
const $=id=>document.getElementById(id);
function renderHUD(){
  $('cash').textContent=S.cash.toFixed(0);
  $('level').textContent=S.level;
  $('goal').textContent=goal;
  const m=Math.floor(timeLeft/60), s=(timeLeft%60|0).toString().padStart(2,'0');
  $('time').textContent=`${m}:${s}`;
  $('ovenBar').style.width=(S.ovenLvl*10)+'%';
  $('speedBar').style.width=(S.workerSpeed*10)+'%';
  $('capBar').style.width=(S.carryCap*10)+'%';
  $('mkBar').style.width=(S.marketing*10)+'%';
}
function save(){ localStorage.setItem('pf_iso_levels', JSON.stringify(S)); }

const overlay=$('overlay'); const ovTitle=$('ovTitle'), ovBody=$('ovBody'), ovBtn=$('ovBtn');
$('btnTut').onclick=()=>{ ovTitle.textContent='Ø´Ø±Ø­ Ø³Ø±ÙŠØ¹'; ovBody.textContent='Ø§Ù„Ø³ÙŠØ± ÙŠÙ†Ù‚Ù„ Ø§Ù„Ø¹Ø¬ÙŠÙ† Ù„Ù„ÙØ±Ù†. Ø§Ù„Ø¹Ø§Ù…Ù„ ÙŠØ­Ù…Ù„ Ù…Ù† Ø§Ù„Ù…Ø®Ø²Ù† ÙˆÙŠØ³Ù„Ù‘Ù…. Ø­Ù‚Ù‘Ù‚ Ø§Ù„Ù‡Ø¯Ù Ù‚Ø¨Ù„ Ø§Ù„ÙˆÙ‚Øª.'; overlay.style.display='grid'; };
$('btnMute').onclick=()=>{ muted=!muted; $('btnMute').textContent = muted?'ğŸ”‡ ØµØ§Ù…Øª':'ğŸ”Š ØµÙˆØª'; };
$('btnRestart').onclick=()=>{ startLevel(S.level,true); };

$('upOven').onclick=()=>{ if(S.cash>=120){ S.cash-=120; S.ovenLvl++; beep(900); renderHUD(); save(); } };
$('upSpeed').onclick=()=>{ if(S.cash>=100){ S.cash-=100; S.workerSpeed++; beep(760); renderHUD(); save(); } };
$('upCap').onclick=()=>{ if(S.cash>=150){ S.cash-=150; S.carryCap++; beep(640); renderHUD(); save(); } };
$('upMk').onclick=()=>{ if(S.cash>=130){ S.cash-=130; S.marketing++; beep(520); renderHUD(); save(); } };
$('save').onclick=save; $('reset').onclick=()=>{ localStorage.removeItem('pf_iso_levels'); location.reload(); };

// Levels control (Ù…Ø¹ Ø²Ø¨Ø§Ø¦Ù† Ù…Ø¨Ø¯Ø¦ÙŠÙŠÙ†)
function startLevel(n, resetCash=false){
  const L=LEVELS[n-1];
  timeLeft=L.time; goal=L.goal;
  S.ovenLvl=L.oven; S.workerSpeed=L.speed; S.carryCap=L.cap; S.marketing=L.mk;
  oven.stock=0; counter.stock=0; customers.length=0; spawnT=1/spawnRate();
  for(let i=0;i<3;i++) spawnCustomer();
  renderHUD();
  overlay.style.display='grid'; ovTitle.textContent=`Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${n}`; ovBody.textContent=`Ø§Ù„Ù‡Ø¯Ù ${goal} Ø®Ù„Ø§Ù„ ${L.time} Ø«Ø§Ù†ÙŠØ©`; ovBtn.textContent='Ø§Ø¨Ø¯Ø£';
}
startLevel(S.level,true);
ovBtn.onclick=()=>{ overlay.style.display='none'; last=performance.now(); };

// Spawn & serve (Ù…Ù† ØºÙŠØ± Ø¶ØºØ·)
function spawnCustomer(){
  const range=LEVELS[S.level-1].order;
  const n = range[0] + Math.floor(Math.random()*(range[1]-range[0]+1));
  const baseY = 160 + Math.random()*60;
  const p=iso(420, baseY);
  customers.push({isoX:420, isoY:baseY, scrX:p.X, scrY:p.Y, order:n, pat:patienceMax(), served:false, leaving:false});
}
function serveFromCounter(){
  const c = customers.find(z=>!z.served && !z.leaving);
  if(!c) return;
  const give = Math.min(counter.stock, c.order);
  if(give>0){
    c.order -= give; counter.stock -= give;
    const pay=give*10; S.cash += pay;
    if(c.order===0){ c.served=true; beep(880,0.07,'sine',0.04); }
    renderHUD(); save();
  }
}

// Worker FSM
const P_STACK=iso(210,150), P_COUNTER=iso(320,150);
function workerSpeedPx(){ return (90 + S.workerSpeed*26); }
function moveTo(o,tx,ty,dt){ const dx=tx-o.x, dy=ty-o.y; const d=Math.hypot(dx,dy); if(d>1){ o.x+=dx/d*workerSpeedPx()*dt; o.y+=dy/d*workerSpeedPx()*dt; } }
function closeTo(o,tx,ty,eps){ return Math.hypot(o.x-tx,o.y-ty)<=eps; }
function stepWorker(dt){
  if(worker.state==='toStack'){ moveTo(worker,P_STACK.X,P_STACK.Y,dt); if(closeTo(worker,P_STACK.X,P_STACK.Y,10)) worker.state='pickup'; }
  else if(worker.state==='pickup'){
    if(oven.stock>0 && worker.carrying<S.carryCap){ oven.stock--; worker.carrying++; }
    if(worker.carrying>=S.carryCap || oven.stock===0){ worker.state='toCounter'; }
  } else if(worker.state==='toCounter'){ moveTo(worker,P_COUNTER.X,P_COUNTER.Y,dt); if(closeTo(worker,P_COUNTER.X,P_COUNTER.Y,10)) worker.state='drop'; }
  else if(worker.state==='drop'){
    if(worker.carrying>0 && counter.stock<counter.limit){ counter.stock++; worker.carrying--; }
    if(worker.carrying===0){ worker.state='toStack'; }
  }
}

// Conveyor (animated)
let beltPhase=0;
function drawBelt(x1,y1,x2,y2){
  const dx=x2-x1, dy=y2-y1, len=Math.hypot(dx,dy), ang=Math.atan2(dy,dx);
  ctx.save(); ctx.translate(x1,y1); ctx.rotate(ang);
  ctx.fillStyle='#334155'; ctx.fillRect(0,-10,len,20);
  const step=20, phase=(beltPhase%step);
  ctx.fillStyle='#94a3b8'; for(let x=-phase; x<len; x+=step){ ctx.fillRect(x-4,-6,8,12); }
  ctx.restore();
}

// Loop (Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙŠØªØ­Ø±Ù‘Ùƒ ÙØ¹Ù„ÙŠÙ‹Ø§)
let last = performance.now();
function loop(now){
  let dt=(now-last)/1000; last=now; if(!isFinite(dt)||dt<=0) dt=0.016; dt=Math.min(dt,0.033);

  if(overlay.style.display==='grid'){ requestAnimationFrame(loop); return; }

  timeLeft -= dt;
  renderHUD();                      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙƒÙ„ ÙØ±ÙŠÙ…

  if(timeLeft<=0){
    if(S.cash>=goal){
      S.level = Math.min(LEVELS.length, S.level+1); save();
      startLevel(S.level,true); ovTitle.textContent='Ù…Ø¨Ø±ÙˆÙƒ!'; ovBody.textContent='Ø§Ù†ØªÙ‚Ù„Øª Ù„Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ§Ù„ÙŠ'; ovBtn.textContent='ØªØ§Ø¨Ø¹';
    }else{
      startLevel(S.level,true); ovTitle.textContent='Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª'; ovBody.textContent='Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ù‡Ø¯Ù'; ovBtn.textContent='Ø¥Ø¹Ø§Ø¯Ø©';
    }
  }

  spawnT -= dt; if(spawnT<=0){ spawnT=1/spawnRate(); spawnCustomer(); }
  oven.timer -= dt; if(oven.timer<=0){ oven.timer=ovenInterval(); if(oven.stock<oven.limit){ oven.stock++; beep(520,0.05,'square',0.02); } }

  customers.forEach(c=>{ if(!c.served){ c.pat -= dt; if(c.pat<=0){ c.leaving=true; } }
    if(c.served||c.leaving){ c.isoX+= (c.served? 100:140)*dt; const p=iso(c.isoX,c.isoY); c.scrX=p.X; c.scrY=p.Y; } });
  serveFromCounter(); stepWorker(dt); beltPhase=(beltPhase+dt*60)%40;

  draw(); requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

// Draw
function draw(){
  ctx.clearRect(0,0,W(),H());
  // ground
  ctx.fillStyle=grad(0,H()-300,0,H(),'#f7fbff','#ffffff'); ctx.fillRect(0,H()-300,W(),300);
  ctx.strokeStyle='#e9eef6'; for(let x=0;x<W();x+=40){ ctx.beginPath(); ctx.moveTo(x,H()-300); ctx.lineTo(x,H()); ctx.stroke(); } for(let y=H()-300;y<H();y+=40){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W(),y); ctx.stroke(); }

  // belt
  const b1=iso(140,150), b2=iso(200,150); drawBelt(b1.X,b1.Y,b2.X,b2.Y);

  // oven (sprite fallback)
  const pO=iso(200,150);
  if(spritesReady && GFX.oven) { drawSprite(GFX.oven,pO.X-48,pO.Y-48); }
  else { shadow(()=>{ ctx.fillStyle='#60a5fa'; ctx.fillRect(pO.X-48,pO.Y-32,96,64); }); }

  // stock stack + counter
  drawStack(iso(230,150).X, iso(230,150).Y, oven.stock);
  const pC=iso(320,150); drawCounter(pC.X,pC.Y); drawStack(pC.X+40,pC.Y+18,counter.stock,true);

  // worker
  if(spritesReady && GFX.worker) drawSprite(GFX.worker, worker.x-32, worker.y-38);
  else { shadow(()=>{ ctx.fillStyle='#2563eb'; ctx.beginPath(); ctx.arc(worker.x, worker.y-18, 18, 0, Math.PI*2); ctx.fill(); ctx.fillRect(worker.x-20, worker.y-6, 40, 30); }); }
  for(let i=0;i<worker.carrying;i++){ drawPizza(worker.x+16, worker.y-8 - i*8, 0.6); }

  // customers
  customers.forEach(c=>{ const p=iso(c.isoX,c.isoY); c.scrX=p.X; c.scrY=p.Y;
    if(spritesReady && GFX.customer) drawSprite(GFX.customer, p.X-28, p.Y-28);
    else { shadow(()=>{ ctx.fillStyle='#94a3b8'; ctx.beginPath(); ctx.arc(p.X, p.Y, 16, 0, Math.PI*2); ctx.fill(); ctx.fillStyle='#1f2937'; ctx.fillRect(p.X-12, p.Y+2, 24, 22); }); }
    drawBubble(p.X,p.Y-30,c.order,c.pat/patienceMax());
  });

  // timer bar
  const w = Math.max(0, (timeLeft/LEVELS[S.level-1].time)*100); ctx.fillStyle='#e2e8f0'; ctx.fillRect(W()-210,14,190,10); ctx.fillStyle='#22c55e'; ctx.fillRect(W()-210,14,1.9*w,10);
}

// Draw helpers
function drawSprite(bmp,x,y){ if(!bmp) return; shadow(()=>ctx.drawImage(bmp,x,y)); }
function drawPizza(x,y,scale=1){ if(!GFX.pizza) { ctx.fillStyle='#f59e0b'; ctx.beginPath(); ctx.ellipse(x,y,16*scale,6*scale,0,0,Math.PI*2); ctx.fill(); ctx.strokeStyle='#b45309'; ctx.stroke(); return; } ctx.drawImage(GFX.pizza, x-20*scale, y-10*scale, 40*scale, 40*scale); }
function drawStack(x,y,count,small){ const layers=Math.min(10,count); for(let i=0;i<layers;i++){ drawPizza(x, y-i*(small?6:8), small?.5:1); } }
function drawCounter(x,y){ shadow(()=>{ ctx.fillStyle='#ef4444'; ctx.fillRect(x-60,y-24,160,64); }); }
function drawBubble(x,y,n,pat){ ctx.fillStyle='rgba(255,255,255,.96)'; ctx.strokeStyle='#d1d8e2'; ctx.lineWidth=2; ctx.fillRect(x-20,y-26,46,24); ctx.strokeRect(x-20,y-26,46,24); ctx.font='18px system-ui'; ctx.fillStyle='#111'; ctx.fillText('ğŸ•',x-16,y-8); ctx.fillText(String(n),x+2,y-8); ctx.fillStyle='#e2e8f0'; ctx.fillRect(x-22,y-2,44,5); ctx.fillStyle=pat>0.5?'#22c55e':(pat>0.25?'#f59e0b':'#ef4444'); ctx.fillRect(x-22,y-2,44*pat,5); }

renderHUD();
</script>
</body>
</html>

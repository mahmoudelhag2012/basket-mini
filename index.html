<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>Falling Blocks DX — Tetris HTML5 (AR)</title>
  <meta name="theme-color" content="#0b1023">
  <style>
    body{margin:0;background:#0b1023;color:#fff;font-family:sans-serif;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh}
    canvas#cv{background:#16224a;border:2px solid #333;border-radius:8px}
    .hud{display:flex;gap:20px;margin:8px;font-size:14px}
    #next{background:#111;border:1px solid #333;margin:8px;border-radius:6px}
    .controls{display:grid;grid-template-columns:repeat(3,80px);grid-template-rows:repeat(2,80px);gap:8px;margin-top:12px}
    .controls button{font-size:22px;font-weight:bold;border:none;border-radius:10px;background:#223c6b;color:#fff;box-shadow:0 4px 8px rgba(0,0,0,.4);cursor:pointer}
    .controls button:active{transform:scale(0.95)}
    .span2{grid-column:span 2}
  </style>
</head>
<body>
  <div class="hud">
    <div>النتيجة: <span id="score">0</span></div>
    <div>الخطوط: <span id="lines">0</span></div>
    <div>المستوى: <span id="level">1</span></div>
    <div>أفضل: <span id="best">0</span></div>
  </div>
  <canvas id="cv" width="300" height="600"></canvas>
  <canvas id="next" width="100" height="100"></canvas>
  <div class="controls">
    <div></div>
    <button id="rotBtn">⤿</button>
    <div></div>
    <button id="leftBtn">⟵</button>
    <button id="downBtn">⬇</button>
    <button id="rightBtn">⟶</button>
    <button id="hardBtn" class="span2">⬇⬇</button>
  </div>
<script>
(()=>{
  const COLS=10, ROWS=20, cv=document.getElementById('cv'),cx=cv.getContext('2d'),W=cv.width,H=cv.height,CS=W/COLS;
  const nextCV=document.getElementById('next'),nx=nextCV.getContext('2d');
  const scoreEl=document.getElementById('score'),linesEl=document.getElementById('lines'),levelEl=document.getElementById('level'),bestEl=document.getElementById('best');
  let grid,cur,bag=[],nextPiece=null,score=0,lines=0,level=1,best=Number(localStorage.getItem('tetris_best')||0);
  let dropInterval=900,dropTimer=0,lastTime=0,running=false,paused=false;
  const COLORS={I:'#00f0f0',O:'#f0f000',T:'#a000f0',S:'#00f000',Z:'#f00000',J:'#0000f0',L:'#f0a000'};
  const SHAPES={
    I:[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],
    O:[[1,1],[1,1]],
    T:[[0,1,0],[1,1,1],[0,0,0]],
    S:[[0,1,1],[1,1,0],[0,0,0]],
    Z:[[1,1,0],[0,1,1],[0,0,0]],
    J:[[1,0,0],[1,1,1],[0,0,0]],
    L:[[0,0,1],[1,1,1],[0,0,0]]
  };
  function emptyGrid(){return Array.from({length:ROWS},()=>Array(COLS).fill(0));}
  function newPiece(type){let s=SHAPES[type].map(r=>[...r]);return{type,shape:s,x:Math.floor(COLS/2)-2,y:-2,color:COLORS[type]};}
  function takeFromBag(){if(!bag.length)bag=Object.keys(SHAPES).sort(()=>Math.random()-.5);return bag.pop();}
  function spawn(){let t=nextPiece||takeFromBag();cur=newPiece(t);nextPiece=takeFromBag();drawNext();if(collide(cur,cur.x,cur.y)) gameOver();}
  function collide(p,nx,ny,shape=p.shape){for(let y=0;y<shape.length;y++)for(let x=0;x<shape[y].length;x++){if(!shape[y][x])continue;let gx=nx+x,gy=ny+y;if(gy<0)continue;if(gx<0||gx>=COLS||gy>=ROWS)return true;if(grid[gy][gx])return true;}return false;}
  function merge(p){for(let y=0;y<p.shape.length;y++)for(let x=0;x<p.shape[y].length;x++){if(!p.shape[y][x])continue;let gx=p.x+x,gy=p.y+y;if(gy>=0)grid[gy][gx]=p.color;}}
  function rotateCW(s){let N=s.length,res=Array.from({length:N},()=>Array(N).fill(0));for(let y=0;y<N;y++)for(let x=0;x<N;x++)res[x][N-1-y]=s[y][x];return res;}
  function tryRotate(){let r=rotateCW(cur.shape),kicks=[0,-1,1,-2,2];for(let dx of kicks){if(!collide(cur,cur.x+dx,cur.y,r)){cur.shape=r;cur.x+=dx;return;}}}
  function clearLines(){let c=0;for(let y=ROWS-1;y>=0;){if(grid[y].every(v=>v)){grid.splice(y,1);grid.unshift(Array(COLS).fill(0));c++;}else y--;}if(c){score+=[0,100,300,500,800][c]||c*300;lines+=c;level=1+Math.floor(lines/10);dropInterval=Math.max(120,900-(level-1)*70);}}
  function draw(){cx.clearRect(0,0,W,H);cx.strokeStyle='#333';for(let x=0;x<=COLS;x++){cx.beginPath();cx.moveTo(x*CS,0);cx.lineTo(x*CS,H);cx.stroke();}for(let y=0;y<=ROWS;y++){cx.beginPath();cx.moveTo(0,y*CS);cx.lineTo(W,y*CS);cx.stroke();}for(let y=0;y<ROWS;y++)for(let x=0;x<COLS;x++)if(grid[y][x])drawCell(x,y,grid[y][x]);for(let y=0;y<cur.shape.length;y++)for(let x=0;x<cur.shape[y].length;x++)if(cur.shape[y][x])drawCell(cur.x+x,cur.y+y,cur.color);}
  function drawCell(gx,gy,color){if(gy<0)return;cx.fillStyle=color;cx.fillRect(gx*CS,gy*CS,CS,CS);cx.strokeStyle='#111';cx.strokeRect(gx*CS,gy*CS,CS,CS);}
  function drawNext(){nx.clearRect(0,0,nextCV.width,nextCV.height);let s=SHAPES[nextPiece],c=COLORS[nextPiece];for(let y=0;y<s.length;y++)for(let x=0;x<s[y].length;x++)if(s[y][x]){nx.fillStyle=c;nx.fillRect(x*25,y*25,25,25);nx.strokeStyle='#111';nx.strokeRect(x*25,y*25,25,25);}}
  function move(dx,dy){if(!collide(cur,cur.x+dx,cur.y+dy)){cur.x+=dx;cur.y+=dy;return true;}return false;}
  function hardDrop(){while(move(0,1));lock();}
  function lock(){merge(cur);clearLines();spawn();updateHUD();draw();}
  function updateHUD(){scoreEl.textContent=score;linesEl.textContent=lines;levelEl.textContent=level;bestEl.textContent=Math.max(best,score);}
  function gameOver(){running=false;best=Math.max(best,score);localStorage.setItem('tetris_best',best);updateHUD();alert('انتهت اللعبة! نتيجتك: '+score);}
  function update(dt){dropTimer+=dt;if(dropTimer>dropInterval){dropTimer=0;if(!move(0,1))lock();}}
  function tick(now){if(!running)return;let dt=now-lastTime;lastTime=now;update(dt);draw();requestAnimationFrame(tick);}
  function startGame(){grid=emptyGrid();score=0;lines=0;level=1;dropInterval=900;running=true;nextPiece=null;spawn();updateHUD();lastTime=performance.now();requestAnimationFrame(tick);}
  // inputs
  document.getElementById('leftBtn').onclick=()=>{if(running){move(-1,0);draw();}};
  document.getElementById('rightBtn').onclick=()=>{if(running){move(1,0);draw();}};
  document.getElementById('downBtn').onclick=()=>{if(running){if(move(0,1)){score++;updateHUD();draw();}}};
  document.getElementById('rotBtn').onclick=()=>{if(running){tryRotate();draw();}};
  document.getElementById('hardBtn').onclick=()=>{if(running){hardDrop();draw();}};
  window.addEventListener('keydown',e=>{if(!running)return;if(e.key==='ArrowLeft')move(-1,0);if(e.key==='ArrowRight')move(1,0);if(e.key==='ArrowDown'){if(move(0,1)){score++;updateHUD();}}if(e.key==='ArrowUp')tryRotate();if(e.code==='Space')hardDrop();draw();});
  startGame();
})();
</script>
</body>
</html>

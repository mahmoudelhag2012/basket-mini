<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Pizza Factory — Isometric + Levels</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root{--bg:#eaf2ff;--card:#fff;--ink:#0f172a;--muted:#6b7280;--accent:#22c55e;--accent2:#3b82f6;--danger:#ef4444;--shadow:0 10px 28px rgba(0,0,0,.08)}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Cairo",sans-serif;background:radial-gradient(1000px 540px at 50% -10%,#fff,var(--bg));color:var(--ink);display:flex;justify-content:center}
.app{width:min(1040px,100%);padding:12px}
.frame{background:var(--card);border-radius:24px;box-shadow:var(--shadow);overflow:hidden;border:1px solid #e8eef5}
.top{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:10px 14px;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff}
.stats{display:flex;gap:10px;flex-wrap:wrap}
.pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:rgba(255,255,255,.16);font-weight:700}
.grid{display:grid;grid-template-columns:1.2fr .8fr;gap:10px;padding:10px}
.panel{background:#f8fafc;border:1px solid #eef2f7;border-radius:18px;padding:10px}
.panel canvas{display:block;margin-inline:auto;width:100%;max-width:1000px;aspect-ratio:16/9;height:auto;background:linear-gradient(#f5fbff,#fff);border-radius:12px}
.row{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px 0}
.btn{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:10px 12px;box-shadow:var(--shadow);cursor:pointer;font-weight:700}
.btn:active{transform:translateY(1px)}
.meter{height:10px;border-radius:999px;background:#eef2f7;overflow:hidden}
.meter>span{display:block;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2))}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;padding:8px}
.iconbtn{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:var(--shadow);font-weight:700}
.hud{display:flex;justify-content:space-between;align-items:center;color:var(--muted);padding:6px 10px}
.overlay{position:fixed;inset:0;background:rgba(15,23,42,.66);display:none;place-items:center;z-index:50}
.card{background:#fff;border-radius:18px;padding:16px;width:min(520px,90%);box-shadow:var(--shadow);text-align:center}
.card h2{margin:8px 0}
@media (max-width:780px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="app">
  <div class="frame">
    <div class="top">
      <b>Pizza Factory — إيزومتريك + مراحل</b>
      <div class="stats">
        <div class="pill">💰 <b id="cash">0</b></div>
        <div class="pill">⭐ المستوى <b id="level">1</b></div>
        <div class="pill">🎯 المتبقي <b id="goalLeft">0</b></div>
        <div class="pill">⏳ الوقت <b id="time">00:00</b></div>
      </div>
    </div>

    <div class="grid">
      <div class="panel">
        <h3>الملعب (Isometric + Sprites)</h3>
        <canvas id="cv"></canvas>
        <div class="toolbar">
          <button class="iconbtn" id="btnTut">📘 شرح سريع</button>
          <button class="iconbtn" id="btnMute">🔊 صوت</button>
          <button class="iconbtn" id="btnRestart">🔁 إعادة</button>
        </div>
      </div>
      <div class="panel">
        <h3>ترقيات (تؤثر فورًا)</h3>
        <div class="row"><div>⏱️ سرعة الفرن</div><div><div class="meter" style="width:160px"><span id="ovenBar" style="width:20%"></span></div> <button class="btn" id="upOven">+ (120💰)</button></div></div>
        <div class="row"><div>🏃‍♂️ سرعة العامل</div><div><div class="meter" style="width:160px"><span id="speedBar" style="width:20%"></span></div> <button class="btn" id="upSpeed">+ (100💰)</button></div></div>
        <div class="row"><div>🧺 سعة الحمل</div><div><div class="meter" style="width:160px"><span id="capBar" style="width:20%"></span></div> <button class="btn" id="upCap">+ (150💰)</button></div></div>
        <div class="row"><div>📣 تسويق (يزود الزبائن)</div><div><div class="meter" style="width:160px"><span id="mkBar" style="width:0%"></span></div> <button class="btn" id="upMk">+ (130💰)</button></div></div>
        <div class="row"><div>حفظ</div><div><button class="btn" id="save">حفظ</button> <button class="btn" id="reset">بداية جديدة</button></div></div>
      </div>
    </div>

    <div class="hud">
      <div>👷 العامل يحمل من المخزن ويسلّم على الكاوُنتر</div>
      <div>🎵 أصوات خفيفة عند الإنتاج والتسليم</div>
    </div>
  </div>
</div>

<div class="overlay" id="overlay">
  <div class="card">
    <h2 id="ovTitle">شرح سريع</h2>
    <p id="ovBody">اضغط “حسناً” للبدء. حقّق الهدف قبل نهاية الوقت.</p>
    <button class="btn" id="ovBtn">حسناً</button>
  </div>
</div>

<script>
// Telegram
const tg = window.Telegram?.WebApp; if(tg){try{tg.ready();tg.expand();}catch(e){}}

// Canvas HiDPI + responsive
const cv = document.getElementById('cv');
const ctx = cv.getContext('2d');
function scaleCanvas(){
  const dpr = Math.max(1, window.devicePixelRatio||1);
  const rect = cv.getBoundingClientRect();
  const cssW = Math.max(640, Math.floor(rect.width||960));
  const cssH = Math.max(360, Math.floor(rect.height||cssW*9/16));
  cv.width=Math.floor(cssW*dpr); cv.height=Math.floor(cssH*dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
new ResizeObserver(scaleCanvas).observe(cv); scaleCanvas();
const W = ()=> (cv.getBoundingClientRect().width || 960);
const H = ()=> (cv.getBoundingClientRect().height|| 540);

// Helpers
function shadow(f){ctx.save();ctx.shadowColor='rgba(0,0,0,.18)';ctx.shadowBlur=12;ctx.shadowOffsetY=6;f();ctx.restore();}
function grad(x0,y0,x1,y1,c0,c1){const g=ctx.createLinearGradient(x0,y0,x1,y1);g.addColorStop(0,c0);g.addColorStop(1,c1);return g;}

// Sprites (SVG)
const SPRITES = {
  worker:`<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64' viewBox='0 0 64 64'>
    <defs><linearGradient id='b' x1='0' x2='1'><stop offset='0' stop-color='#60a5fa'/><stop offset='1' stop-color='#2563eb'/></linearGradient></defs>
    <circle cx='32' cy='22' r='12' fill='#f97316'/><rect x='18' y='28' width='28' height='24' rx='6' fill='url(#b)'/>
    <rect x='16' y='16' width='18' height='6' rx='3' fill='#1d4ed8'/><rect x='34' y='18' width='10' height='4' fill='#1d4ed8'/>
  </svg>`,
  customer:`<svg xmlns='http://www.w3.org/2000/svg' width='56' height='56' viewBox='0 0 56 56'>
    <circle cx='28' cy='18' r='10' fill='#94a3b8'/><rect x='16' y='24' width='24' height='20' rx='6' fill='#1f2937'/>
  </svg>`,
  oven:`<svg xmlns='http://www.w3.org/2000/svg' width='96' height='64' viewBox='0 0 96 64'>
    <defs><linearGradient id='o' x1='0' x2='1'><stop offset='0' stop-color='#60a5fa'/><stop offset='1' stop-color='#2563eb'/></linearGradient></defs>
    <rect x='2' y='8' width='92' height='48' rx='10' fill='url(#o)'/><rect x='12' y='22' width='72' height='20' rx='6' fill='#1d4ed8'/>
  </svg>`,
  pizza:`<svg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 40 40'>
    <ellipse cx='20' cy='24' rx='16' ry='6' fill='#f59e0b' stroke='#b45309' stroke-width='2'/><text x='12' y='28' font-size='16'>🍕</text>
  </svg>`
};
let spritesReady=false; const GFX={};
async function svgToBitmap(svg){try{const b=new Blob([svg],{type:'image/svg+xml'});const u=URL.createObjectURL(b);const i=new Image();i.decoding='async';i.src=u;await i.decode();const x=await createImageBitmap(i);URL.revokeObjectURL(u);return x;}catch{return null;}}
(async()=>{for(const k in SPRITES){GFX[k]=await svgToBitmap(SPRITES[k]);}spritesReady=true;})();

// Sound
let audioCtx=null, muted=false;
function beep(freq=880,dur=0.06,type='triangle',gain=0.03){
  if(muted) return; if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type=type; o.frequency.value=freq; g.gain.value=gain; o.connect(g).connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+dur);
}

// Levels
const LEVELS=[
  {goal:200,time:60, spawn:0.55, order:[1,2], oven:2, speed:1, cap:3, mk:0},
  {goal:350,time:70, spawn:0.70, order:[1,3], oven:3, speed:1, cap:3, mk:1},
  {goal:500,time:80, spawn:0.85, order:[2,3], oven:3, speed:2, cap:4, mk:1},
  {goal:700,time:90, spawn:1.00, order:[2,3], oven:4, speed:2, cap:5, mk:2},
];

// State
const S = JSON.parse(localStorage.getItem('pf_iso_levels')||'null') || {level:1, cash:200, ovenLvl:2, workerSpeed:1, carryCap:3, marketing:0};
let timeLeft=LEVELS[S.level-1].time, goal=LEVELS[S.level-1].goal;
let levelStartCash=S.cash;

// Isometric origin ثابت
function isoOrigin(){ return {ox: W()*0.50, oy: H()*0.60}; }
const iso = (x,y)=>{ const {ox,oy}=isoOrigin(); return {X:x-y+ox, Y:(x+y)*0.5+oy}; };

// Entities & positions
const oven={timer:0, stock:0, limit:99};
const counter={stock:0, limit:40};
const worker={x:iso(0,0).X, y:iso(0,0).Y, carrying:0, state:'toStack'};
const customers=[];
const POS={ oven:{x:-120,y:-20}, stack:{x:-60,y:-20}, counter:{x:140,y:-20}, queueX:230 };

// Rates
function ovenInterval(){ return Math.max(0.6, 2.2 - S.ovenLvl*0.18); }
function spawnRate(){ return LEVELS[S.level-1].spawn + S.marketing*0.05; }
function patienceMax(){ return 6.5 + S.marketing*0.2; }
let spawnT=1/spawnRate();

// HUD
const $=id=>document.getElementById(id);
function goalCompleted(){ return S.cash - levelStartCash; }
function goalLeft(){ return Math.max(0, goal - goalCompleted()); }
function renderHUD(){
  $('cash').textContent=S.cash.toFixed(0);
  $('level').textContent=S.level;
  $('goalLeft').textContent=goalLeft().toFixed(0);
  const m=Math.floor(timeLeft/60), s=(timeLeft%60|0).toString().padStart(2,'0');
  $('time').textContent=`${m}:${s}`;
  $('ovenBar').style.width=(S.ovenLvl*10)+'%';
  $('speedBar').style.width=(S.workerSpeed*10)+'%';
  $('capBar').style.width=(S.carryCap*10)+'%';
  $('mkBar').style.width=(S.marketing*10)+'%';
}
function save(){ localStorage.setItem('pf_iso_levels', JSON.stringify(S)); }

// Overlay & controls
const overlay=$('overlay'), ovTitle=$('ovTitle'), ovBody=$('ovBody'), ovBtn=$('ovBtn');
$('btnTut').onclick=()=>{ ovTitle.textContent='شرح سريع'; ovBody.textContent='الفرن ينتج باستمرار؛ العامل يحمّل ويسلّم للزبائن. حقّق الهدف قبل الوقت.'; overlay.style.display='grid'; };
$('btnMute').onclick=()=>{ muted=!muted; $('btnMute').textContent=muted?'🔇 صامت':'🔊 صوت'; };
$('btnRestart').onclick=()=>{ startLevel(S.level,true); };
$('upOven').onclick=()=>{ if(S.cash>=120){ S.cash-=120; S.ovenLvl++; beep(900); renderHUD(); save(); } };
$('upSpeed').onclick=()=>{ if(S.cash>=100){ S.cash-=100; S.workerSpeed++; beep(760); renderHUD(); save(); } };
$('upCap').onclick=()=>{ if(S.cash>=150){ S.cash-=150; S.carryCap++; beep(640); renderHUD(); save(); } };
$('upMk').onclick=()=>{ if(S.cash>=130){ S.cash-=130; S.marketing++; beep(520); renderHUD(); save(); } };
$('save').onclick=save; $('reset').onclick=()=>{ localStorage.removeItem('pf_iso_levels'); location.reload(); };

// Level start
function startLevel(n, resetBaseline=false){
  const L=LEVELS[n-1];
  timeLeft=L.time; goal=L.goal;
  S.ovenLvl=L.oven; S.workerSpeed=L.speed; S.carryCap=L.cap; S.marketing=L.mk;
  if(resetBaseline) levelStartCash=S.cash;        // أساس جديد لحساب المتبقي
  oven.stock=0; counter.stock=0; customers.length=0; spawnT=1/spawnRate();
  for(let i=0;i<3;i++) spawnCustomer();
  renderHUD();
  overlay.style.display='grid'; ovTitle.textContent=`المستوى ${n}`; ovBody.textContent=`المتبقي ${goalLeft()} خلال ${L.time} ثانية`; ovBtn.textContent='ابدأ';
}
startLevel(S.level,true);
ovBtn.onclick=()=>{ overlay.style.display='none'; last=performance.now(); };

// Spawn & serve
function spawnCustomer(){
  const range=LEVELS[S.level-1].order;
  const n = range[0] + Math.floor(Math.random()*(range[1]-range[0]+1));
  const baseY = -20 + Math.random()*60;
  const p=iso(POS.queueX, baseY);
  customers.push({isoX:POS.queueX, isoY:baseY, scrX:p.X, scrY:p.Y, order:n, pat:patienceMax(), served:false, leaving:false});
}
function serveFromCounter(){
  const c = customers.find(z=>!z.served && !z.leaving);
  if(!c) return;
  const give = Math.min(counter.stock, c.order);
  if(give>0){
    c.order -= give; counter.stock -= give;
    const pay=give*10; S.cash += pay;
    if(c.order===0){ c.served=true; beep(880,0.07,'sine',0.04); }
    renderHUD(); save();
  }
}

// Worker FSM
const P_STACK=iso(POS.stack.x,POS.stack.y), P_COUNTER=iso(POS.counter.x,POS.counter.y);
function workerSpeedPx(){ return (90 + S.workerSpeed*26); }
function moveTo(o,tx,ty,dt){ const dx=tx-o.x, dy=ty-o.y; const d=Math.hypot(dx,dy); if(d>1){ o.x+=dx/d*workerSpeedPx()*dt; o.y+=dy/d*workerSpeedPx()*dt; } }
function closeTo(o,tx,ty,eps){ return Math.hypot(o.x-tx,o.y-ty)<=eps; }
function stepWorker(dt){
  if(worker.state==='toStack'){ moveTo(worker,P_STACK.X,P_STACK.Y,dt); if(closeTo(worker,P_STACK.X,P_STACK.Y,10)) worker.state='pickup'; }
  else if(worker.state==='pickup'){
    if(oven.stock>0 && worker.carrying<S.carryCap){ oven.stock--; worker.carrying++; }
    if(worker.carrying>=S.carryCap || oven.stock===0){ worker.state='toCounter'; }
  } else if(worker.state==='toCounter'){ moveTo(worker,P_COUNTER.X,P_COUNTER.Y,dt); if(closeTo(worker,P_COUNTER.X,P_COUNTER.Y,10)) worker.state='drop'; }
  else if(worker.state==='drop'){
    if(worker.carrying>0 && counter.stock<counter.limit){ counter.stock++; worker.carrying--; }
    if(worker.carrying===0){ worker.state='toStack'; }
  }
}

// Loop
let last = performance.now();
function loop(now){
  let dt=(now-last)/1000; last=now; if(!isFinite(dt)||dt<=0) dt=0.016; dt=Math.min(dt,0.033);
  if(overlay.style.display==='grid'){ requestAnimationFrame(loop); return; }

  // advance level فور ما يتحقق الهدف
  if(goalCompleted() >= goal){
    S.level = Math.min(LEVELS.length, S.level+1); save();
    startLevel(S.level,true); ovTitle.textContent='مبروك!'; ovBody.textContent='انتقلت للمستوى التالي'; ovBtn.textContent='تابع';
    requestAnimationFrame(loop); return;
  }

  timeLeft -= dt;
  renderHUD();

  if(timeLeft<=0){
    if(goalCompleted()>=goal){
      S.level = Math.min(LEVELS.length, S.level+1); save();
      startLevel(S.level,true); ovTitle.textContent='مبروك!'; ovBody.textContent='انتقلت للمستوى التالي'; ovBtn.textContent='تابع';
    }else{
      startLevel(S.level,true); ovTitle.textContent='انتهى الوقت'; ovBody.textContent='حاول مرة أخرى لتحقيق الهدف'; ovBtn.textContent='إعادة';
    }
  }

  spawnT -= dt; if(spawnT<=0){ spawnT=1/spawnRate(); spawnCustomer(); }
  oven.timer -= dt; if(oven.timer<=0){ oven.timer=ovenInterval(); if(oven.stock<oven.limit){ oven.stock++; beep(520,0.05,'square',0.02); } }

  customers.forEach(c=>{ if(!c.served){ c.pat -= dt; if(c.pat<=0) c.leaving=true; }
    if(c.served||c.leaving){ c.isoX += (c.served?100:140)*dt; const p=iso(c.isoX,c.isoY); c.scrX=p.X; c.scrY=p.Y; } });
  serveFromCounter(); stepWorker(dt);

  draw(); requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

// Draw
function draw(){
  ctx.clearRect(0,0,W(),H());

  // أرضية + شبكة خفيفة
  ctx.fillStyle=grad(0,H()-300,0,H(),'#f7fbff','#ffffff'); ctx.fillRect(0,H()-300,W(),300);
  ctx.strokeStyle='#e9eef6';
  for(let x=0;x<W();x+=40){ ctx.beginPath(); ctx.moveTo(x,H()-300); ctx.lineTo(x,H()); ctx.stroke(); }
  for(let y=H()-300;y<H();y+=40){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W(),y); ctx.stroke(); }

  // الفرن
  const pO=iso(POS.oven.x,POS.oven.y);
  if(spritesReady && GFX.oven) shadow(()=>ctx.drawImage(GFX.oven,pO.X-48,pO.Y-48));
  else shadow(()=>{ctx.fillStyle='#60a5fa';ctx.fillRect(pO.X-48,pO.Y-32,96,64);});

  // مخزون + كاونتر
  const pS=iso(POS.stack.x,POS.stack.y); drawStack(pS.X,pS.Y,oven.stock);
  const pC=iso(POS.counter.x,POS.counter.y); drawCounter(pC.X,pC.Y); drawStack(pC.X+40,pC.Y+18,counter.stock,true);

  // العامل
  if(spritesReady && GFX.worker) shadow(()=>ctx.drawImage(GFX.worker,worker.x-32,worker.y-38));
  else shadow(()=>{ctx.fillStyle='#2563eb';ctx.beginPath();ctx.arc(worker.x,worker.y-18,18,0,Math.PI*2);ctx.fill();ctx.fillRect(worker.x-20,worker.y-6,40,30);});
  for(let i=0;i<worker.carrying;i++) drawPizza(worker.x+16,worker.y-8 - i*8,.6);

  // الزبائن (فقاعة بباكجراوند معتم لمنع خطوط الشبكة)
  customers.forEach(c=>{
    const p=iso(c.isoX,c.isoY); c.scrX=p.X; c.scrY=p.Y;
    if(spritesReady && GFX.customer) shadow(()=>ctx.drawImage(GFX.customer,p.X-28,p.Y-28));
    else shadow(()=>{ctx.fillStyle='#94a3b8';ctx.beginPath();ctx.arc(p.X,p.Y,16,0,Math.PI*2);ctx.fill();ctx.fillStyle='#1f2937';ctx.fillRect(p.X-12,p.Y+2,24,22);});
    drawBubble(p.X,p.Y-30,c.order,c.pat/patienceMax());
  });

  // شريط تقدم الهدف (ذهبي)
  const prog = Math.max(0, Math.min(1, goalCompleted()/goal));
  ctx.fillStyle='#e2e8f0'; ctx.fillRect(20,20, W()-220, 10);
  ctx.fillStyle='#eab308'; ctx.fillRect(20,20, (W()-220)*prog, 10);

  // شريط الوقت (أخضر)
  const tprog = Math.max(0, timeLeft/LEVELS[S.level-1].time);
  ctx.fillStyle='#22c55e'; ctx.fillRect(W()-190,20, 170*tprog, 10);
}

// Helpers
function drawPizza(x,y,scale=1){
  if(!GFX.pizza){ ctx.fillStyle='#f59e0b'; ctx.beginPath(); ctx.ellipse(x,y,16*scale,6*scale,0,0,Math.PI*2); ctx.fill(); ctx.strokeStyle='#b45309'; ctx.stroke(); return; }
  ctx.drawImage(GFX.pizza, x-20*scale, y-10*scale, 40*scale, 40*scale);
}
function drawStack(x,y,count,small){ const layers=Math.min(10,count); for(let i=0;i<layers;i++) drawPizza(x, y-i*(small?6:8), small?.5:1); }
function drawCounter(x,y){ shadow(()=>{ ctx.fillStyle='#ef4444'; ctx.fillRect(x-60,y-24,160,64); }); }
function drawBubble(x,y,n,pat){
  shadow(()=>{ ctx.fillStyle='rgba(255,255,255,1)'; ctx.strokeStyle='#d1d8e2'; ctx.lineWidth=2; ctx.fillRect(x-22,y-28,50,26); ctx.strokeRect(x-22,y-28,50,26); });
  ctx.font='18px system-ui'; ctx.fillStyle='#111'; ctx.fillText('🍕',x-18,y-9); ctx.fillText(String(n),x+2,y-9);
  ctx.fillStyle='#e2e8f0'; ctx.fillRect(x-22,y-2,50,5);
  ctx.fillStyle=pat>0.5?'#22c55e':(pat>0.25?'#f59e0b':'#ef4444'); ctx.fillRect(x-22,y-2,50*pat,5);
}

renderHUD();
</script>
</body>
</html>

